[38;5;238mâ”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[0m
       [38;5;238mâ”‚ [0mFile: [1mindex.js[0m
[38;5;238mâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[0m
[38;5;238m   1[0m   [38;5;238mâ”‚[0m [38;5;242m/**[0m[38;5;242m @format [0m[38;5;242m*/[0m
[38;5;238m   2[0m   [38;5;238mâ”‚[0m 
[38;5;238m   3[0m   [38;5;238mâ”‚[0m [38;5;81mrequire[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mdotenv[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m.[0m[38;5;231mconfig[0m[38;5;231m()[0m[38;5;231m;[0m
[38;5;238m   4[0m   [38;5;238mâ”‚[0m [38;5;149mprocess[0m[38;5;231m.[0m[38;5;149menv[0m[38;5;231m.[0m[38;5;231mNODE_ENV[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;149mprocess[0m[38;5;231m.[0m[38;5;149menv[0m[38;5;231m.[0m[38;5;231mNODE_ENV[0m[38;5;231m [0m[38;5;203m||[0m[38;5;231m [0m[38;5;186m"[0m[38;5;186mdevelopment[0m[38;5;186m"[0m[38;5;231m;[0m
[38;5;238m   5[0m   [38;5;238mâ”‚[0m [38;5;81mconst[0m[38;5;231m [0m[38;5;231mexpress[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;81mrequire[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mexpress[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m   6[0m   [38;5;238mâ”‚[0m [38;5;81mconst[0m[38;5;231m [0m[38;5;231mswaggerUi[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;81mrequire[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mswagger-ui-express[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m   7[0m [33m~[0m [38;5;238mâ”‚[0m [38;5;81mconst[0m[38;5;231m [0m[38;5;231mswaggerDocument[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;81mrequire[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186m./swagger-output.json[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m   8[0m   [38;5;238mâ”‚[0m [38;5;81mconst[0m[38;5;231m [0m[38;5;231m{[0m[38;5;231m [0m[38;5;231mMongoClient[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;81mrequire[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mmongodb[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m   9[0m   [38;5;238mâ”‚[0m [38;5;81mconst[0m[38;5;231m [0m[38;5;231mcors[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;81mrequire[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mcors[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m  10[0m   [38;5;238mâ”‚[0m [38;5;81mconst[0m[38;5;231m [0m[38;5;231mmorgan[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;81mrequire[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mmorgan[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m  11[0m   [38;5;238mâ”‚[0m [38;5;81mlet[0m[38;5;231m [0m[38;5;231mgenerate[0m[38;5;231m,[0m[38;5;231m [0m[38;5;231mcount[0m[38;5;231m;[0m
[38;5;238m  12[0m   [38;5;238mâ”‚[0m [38;5;203mimport[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mrandom-words[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m.[0m[38;5;231mthen[0m[38;5;231m([0m[38;5;231m([0m[38;5;208mrandomWords[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m  13[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m([0m[38;5;231m{[0m[38;5;231m [0m[38;5;231mgenerate[0m[38;5;231m,[0m[38;5;231m [0m[38;5;231mcount[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mrandomWords[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m  14[0m   [38;5;238mâ”‚[0m [38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m  15[0m   [38;5;238mâ”‚[0m [38;5;81mconst[0m[38;5;231m [0m[38;5;231mRedis[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;81mrequire[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mioredis[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m  16[0m   [38;5;238mâ”‚[0m [38;5;81mconst[0m[38;5;231m [0m[38;5;231mapp[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mexpress[0m[38;5;231m()[0m[38;5;231m;[0m
[38;5;238m  17[0m   [38;5;238mâ”‚[0m [38;5;81mconst[0m[38;5;231m [0m[38;5;231mport[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;149mprocess[0m[38;5;231m.[0m[38;5;149menv[0m[38;5;231m.[0m[38;5;231mPORT[0m[38;5;231m [0m[38;5;203m||[0m[38;5;231m [0m[38;5;141m5555[0m[38;5;231m;[0m
[38;5;238m  18[0m   [38;5;238mâ”‚[0m [38;5;81mconst[0m[38;5;231m [0m[38;5;231mmulter[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;81mrequire[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mmulter[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m  19[0m   [38;5;238mâ”‚[0m [38;5;81mconst[0m[38;5;231m [0m[38;5;231mfs[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;81mrequire[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mfs[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m.[0m[38;5;231mpromises[0m[38;5;231m;[0m
[38;5;238m  20[0m   [38;5;238mâ”‚[0m [38;5;81mconst[0m[38;5;231m [0m[38;5;231mpath[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;81mrequire[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mpath[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m  21[0m   [38;5;238mâ”‚[0m [38;5;81mconst[0m[38;5;231m [0m[38;5;231mos[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;81mrequire[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mos[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m  22[0m   [38;5;238mâ”‚[0m [38;5;81mconst[0m[38;5;231m [0m[38;5;231mbodyParser[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;81mrequire[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mbody-parser[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m  23[0m   [38;5;238mâ”‚[0m [38;5;81mconst[0m[38;5;231m [0m[38;5;231m{[0m[38;5;231m [0m[38;5;231mcombine_and_convert_json_files[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;81mrequire[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186m./json_combiner[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m  24[0m   [38;5;238mâ”‚[0m [38;5;81mconst[0m[38;5;231m [0m[38;5;231m{[0m[38;5;231m [0m[38;5;231mv4[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231muuidv4[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;81mrequire[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186muuid[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m  25[0m   [38;5;238mâ”‚[0m [38;5;81mconst[0m[38;5;231m [0m[38;5;231mcompression[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;81mrequire[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mcompression[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m  26[0m   [38;5;238mâ”‚[0m [38;5;81mconst[0m[38;5;231m [0m[38;5;231mdiacritics[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;81mrequire[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mdiacritics[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m  27[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;242m//[0m[38;5;242m Redis client for commands[0m
[38;5;238m  28[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;81mconst[0m[38;5;231m [0m[38;5;231mredisCommand[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;203mnew[0m[38;5;231m [0m[38;5;231mRedis[0m[38;5;231m([0m[38;5;231m{[0m
[38;5;238m  29[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231mport[0m[38;5;231m:[0m[38;5;231m [0m[38;5;141m6379[0m[38;5;231m,[0m[38;5;231m [0m[38;5;242m//[0m[38;5;242m Redis port[0m
[38;5;238m  30[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231mhost[0m[38;5;231m:[0m[38;5;231m [0m[38;5;186m"[0m[38;5;186m127.0.0.1[0m[38;5;186m"[0m[38;5;231m,[0m[38;5;231m [0m[38;5;242m//[0m[38;5;242m Redis host[0m
[38;5;238m  31[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m  32[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231mredisCommand[0m[38;5;231m.[0m[38;5;231mon[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186merror[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;231m([0m[38;5;208merr[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m  33[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;149mconsole[0m[38;5;231m.[0m[38;5;81merror[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mRedis Command Client Error: [0m[38;5;186m"[0m[38;5;231m, [0m[38;5;231merr[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m  34[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m  35[0m [32m+[0m [38;5;238mâ”‚[0m 
[38;5;238m  36[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;242m//[0m[38;5;242m Redis client for subscription[0m
[38;5;238m  37[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;81mconst[0m[38;5;231m [0m[38;5;231mredisSubscribe[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;203mnew[0m[38;5;231m [0m[38;5;231mRedis[0m[38;5;231m([0m[38;5;231m{[0m
[38;5;238m  38[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231mport[0m[38;5;231m:[0m[38;5;231m [0m[38;5;141m6379[0m[38;5;231m,[0m[38;5;231m [0m[38;5;242m//[0m[38;5;242m Redis port[0m
[38;5;238m  39[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231mhost[0m[38;5;231m:[0m[38;5;231m [0m[38;5;186m"[0m[38;5;186m127.0.0.1[0m[38;5;186m"[0m[38;5;231m,[0m[38;5;231m [0m[38;5;242m//[0m[38;5;242m Redis host[0m
[38;5;238m  40[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m  41[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231mredisSubscribe[0m[38;5;231m.[0m[38;5;231mon[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186merror[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;231m([0m[38;5;208merr[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m  42[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;149mconsole[0m[38;5;231m.[0m[38;5;81merror[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mRedis Subscribe Client Error: [0m[38;5;186m"[0m[38;5;231m, [0m[38;5;231merr[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m  43[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m  44[0m [32m+[0m [38;5;238mâ”‚[0m 
[38;5;238m  45[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;242m//[0m[38;5;242m Default database name[0m
[38;5;238m  46[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;81mlet[0m[38;5;231m [0m[38;5;231mMESSAGE_DATABASE[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;186m"[0m[38;5;186mmessages[0m[38;5;186m"[0m[38;5;231m;[0m
[38;5;238m  47[0m [32m+[0m [38;5;238mâ”‚[0m 
[38;5;238m  48[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;242m//[0m[38;5;242m Subscribe to Redis channel for DB name updates[0m
[38;5;238m  49[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231mredisSubscribe[0m[38;5;231m.[0m[38;5;231msubscribe[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mDB_SWITCH_CHANNEL[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;231m([0m[38;5;208merr[0m[38;5;231m,[0m[38;5;231m [0m[38;5;208mcount[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m  50[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;203mif[0m[38;5;231m [0m[38;5;231m([0m[38;5;231merr[0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m  51[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;149mconsole[0m[38;5;231m.[0m[38;5;81merror[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mFailed to subscribe: %s[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;231merr[0m[38;5;231m.[0m[38;5;231mmessage[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m  52[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m}[0m[38;5;231m [0m[38;5;203melse[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m  53[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;149mconsole[0m[38;5;231m.[0m[38;5;81mlog[0m[38;5;231m([0m
[38;5;238m  54[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;203m`[0m[38;5;186mS[0m[38;5;186mu[0m[38;5;186mb[0m[38;5;186ms[0m[38;5;186mc[0m[38;5;186mr[0m[38;5;186mi[0m[38;5;186mb[0m[38;5;186me[0m[38;5;186md[0m[38;5;186m [0m[38;5;186ms[0m[38;5;186mu[0m[38;5;186mc[0m[38;5;186mc[0m[38;5;186me[0m[38;5;186ms[0m[38;5;186ms[0m[38;5;186mf[0m[38;5;186mu[0m[38;5;186ml[0m[38;5;186ml[0m[38;5;186my[0m[38;5;186m![0m[38;5;186m [0m[38;5;186mT[0m[38;5;186mh[0m[38;5;186mi[0m[38;5;186ms[0m[38;5;186m [0m[38;5;186mc[0m[38;5;186ml[0m[38;5;186mi[0m[38;5;186me[0m[38;5;186mn[0m[38;5;186mt[0m[38;5;186m [0m[38;5;186mi[0m[38;5;186ms[0m[38;5;186m [0m[38;5;186mc[0m[38;5;186mu[0m[38;5;186mr[0m[38;5;186mr[0m[38;5;186me[0m[38;5;186mn[0m[38;5;186mt[0m[38;5;186ml[0m[38;5;186my[0m[38;5;186m [0m[38;5;186ms[0m[38;5;186mu[0m[38;5;186mb[0m[38;5;186ms[0m[38;5;186mc[0m[38;5;186mr[0m[38;5;186mi[0m[38;5;186mb[0m[38;5;186me[0m[38;5;186md[0m[38;5;186m [0m[38;5;186mt[0m[38;5;186mo[0m[38;5;186m [0m[38;5;203m${[0m[38;5;231mcount[0m[38;5;203m}[0m[38;5;186m [0m[38;5;186mc[0m[38;5;186mh[0m[38;5;186ma[0m[38;5;186mn[0m[38;5;186mn[0m[38;5;186me[0m[38;5;186ml[0m[38;5;186ms[0m[38;5;186m.[0m[38;5;203m`[0m
[38;5;238m  55[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m  56[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m}[0m
[38;5;238m  57[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m  58[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231mredisSubscribe[0m[38;5;231m.[0m[38;5;231mon[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mmessage[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;231m([0m[38;5;208mchannel[0m[38;5;231m,[0m[38;5;231m [0m[38;5;208mmessage[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m  59[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;149mconsole[0m[38;5;231m.[0m[38;5;81mlog[0m[38;5;231m([0m[38;5;203m`[0m[38;5;186mR[0m[38;5;186me[0m[38;5;186mc[0m[38;5;186me[0m[38;5;186mi[0m[38;5;186mv[0m[38;5;186me[0m[38;5;186md[0m[38;5;186m [0m[38;5;186mt[0m[38;5;186mh[0m[38;5;186me[0m[38;5;186m [0m[38;5;186mf[0m[38;5;186mo[0m[38;5;186ml[0m[38;5;186ml[0m[38;5;186mo[0m[38;5;186mw[0m[38;5;186mi[0m[38;5;186mn[0m[38;5;186mg[0m[38;5;186m [0m[38;5;186mm[0m[38;5;186me[0m[38;5;186ms[0m[38;5;186ms[0m[38;5;186ma[0m[38;5;186mg[0m[38;5;186me[0m[38;5;186m [0m[38;5;186mf[0m[38;5;186mr[0m[38;5;186mo[0m[38;5;186mm[0m[38;5;186m [0m[38;5;203m${[0m[38;5;231mchannel[0m[38;5;203m}[0m[38;5;186m:[0m[38;5;186m [0m[38;5;203m${[0m[38;5;231mmessage[0m[38;5;203m}[0m[38;5;203m`[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m  60[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231mMESSAGE_DATABASE[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mmessage[0m[38;5;231m;[0m
[38;5;238m  61[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m  62[0m [32m+[0m [38;5;238mâ”‚[0m 
[38;5;238m  63[0m   [38;5;238mâ”‚[0m [38;5;242m//[0m[38;5;242m Database Connection Management[0m
[38;5;238m  64[0m   [38;5;238mâ”‚[0m [38;5;81mconst[0m[38;5;231m [0m[38;5;231muri[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;149mprocess[0m[38;5;231m.[0m[38;5;149menv[0m[38;5;231m.[0m[38;5;231mMONGODB_URI[0m[38;5;231m;[0m
[38;5;238m  65[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;149mconsole[0m[38;5;231m.[0m[38;5;81mlog[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mURI: [0m[38;5;186m"[0m[38;5;231m, [0m[38;5;231muri[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m  66[0m   [38;5;238mâ”‚[0m [38;5;81mconst[0m[38;5;231m [0m[38;5;231mclient[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;203mnew[0m[38;5;231m [0m[38;5;231mMongoClient[0m[38;5;231m([0m[38;5;231muri[0m[38;5;231m, [0m[38;5;231m{[0m
[38;5;238m  67[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231museNewUrlParser[0m[38;5;231m:[0m[38;5;231m [0m[38;5;141mtrue[0m[38;5;231m,[0m
[38;5;238m  68[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231museUnifiedTopology[0m[38;5;231m:[0m[38;5;231m [0m[38;5;141mtrue[0m[38;5;231m,[0m
[38;5;238m  69[0m [33m~[0m [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231mreplicaSet[0m[38;5;231m:[0m[38;5;231m [0m[38;5;186m"[0m[38;5;186mfortReplicaSet[0m[38;5;186m"[0m[38;5;231m,[0m
[38;5;238m  70[0m [33m~[0m [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231mreadPreference[0m[38;5;231m:[0m[38;5;231m [0m[38;5;186m"[0m[38;5;186msecondaryPreferred[0m[38;5;186m"[0m[38;5;231m,[0m
[38;5;238m  71[0m [33m~[0m [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231mconnectTimeoutMS[0m[38;5;231m:[0m[38;5;231m [0m[38;5;141m30000[0m[38;5;231m,[0m
[38;5;238m  72[0m [33m~[0m [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231msocketTimeoutMS[0m[38;5;231m:[0m[38;5;231m [0m[38;5;141m30000[0m[38;5;231m,[0m
[38;5;238m  73[0m [33m~[0m [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231mmaxPoolSize[0m[38;5;231m:[0m[38;5;231m [0m[38;5;141m350[0m[38;5;231m,[0m
[38;5;238m  74[0m [33m~[0m [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231mminPoolSize[0m[38;5;231m:[0m[38;5;231m [0m[38;5;141m5[0m[38;5;231m,[0m
[38;5;238m  75[0m [33m~[0m [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231mmaxConnecting[0m[38;5;231m:[0m[38;5;231m [0m[38;5;141m32[0m[38;5;231m,[0m
[38;5;238m  76[0m [33m~[0m [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231mmaxIdleTimeMS[0m[38;5;231m:[0m[38;5;231m [0m[38;5;141m5000[0m[38;5;231m,[0m
[38;5;238m  77[0m [33m~[0m [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231mwaitQueueTimeoutMS[0m[38;5;231m:[0m[38;5;231m [0m[38;5;141m15000[0m[38;5;231m,[0m
[38;5;238m  78[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231mretryReads[0m[38;5;231m:[0m[38;5;231m [0m[38;5;141mtrue[0m[38;5;231m,[0m
[38;5;238m  79[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231mretryWrites[0m[38;5;231m:[0m[38;5;231m [0m[38;5;141mtrue[0m[38;5;231m,[0m
[38;5;238m  80[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231mdirectConnection[0m[38;5;231m:[0m[38;5;231m [0m[38;5;141mfalse[0m[38;5;231m,[0m
[38;5;238m  81[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231mwriteConcern[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231m{[0m[38;5;231m [0m[38;5;231mw[0m[38;5;231m:[0m[38;5;231m [0m[38;5;186m"[0m[38;5;186mmajority[0m[38;5;186m"[0m[38;5;231m,[0m[38;5;231m [0m[38;5;231mwtimeout[0m[38;5;231m:[0m[38;5;231m [0m[38;5;141m5000[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m  82[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231mcompressors[0m[38;5;231m:[0m[38;5;231m [0m[38;5;186m"[0m[38;5;186mzlib[0m[38;5;186m"[0m[38;5;231m,[0m
[38;5;238m  83[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231mzlibCompressionLevel[0m[38;5;231m:[0m[38;5;231m [0m[38;5;141m7[0m[38;5;231m,[0m
[38;5;238m  84[0m   [38;5;238mâ”‚[0m [38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m  85[0m [31m_[0m [38;5;238mâ”‚[0m 
[38;5;238m  86[0m   [38;5;238mâ”‚[0m [38;5;81mconst[0m[38;5;231m [0m[38;5;231mredis[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;203mnew[0m[38;5;231m [0m[38;5;231mRedis[0m[38;5;231m([0m[38;5;231m{[0m
[38;5;238m  87[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231mport[0m[38;5;231m:[0m[38;5;231m [0m[38;5;141m6379[0m[38;5;231m,[0m
[38;5;238m  88[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231mhost[0m[38;5;231m:[0m[38;5;231m [0m[38;5;186m"[0m[38;5;186m127.0.0.1[0m[38;5;186m"[0m[38;5;231m,[0m
[38;5;238m  89[0m   [38;5;238mâ”‚[0m [38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m  90[0m   [38;5;238mâ”‚[0m [38;5;231mredis[0m[38;5;231m.[0m[38;5;231mon[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186merror[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;231m([0m[38;5;208merr[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m  91[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;149mconsole[0m[38;5;231m.[0m[38;5;81mlog[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mRedis Error: [0m[38;5;186m"[0m[38;5;231m, [0m[38;5;231merr[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m  92[0m   [38;5;238mâ”‚[0m [38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m  93[0m   [38;5;238mâ”‚[0m 
[38;5;238m  94[0m   [38;5;238mâ”‚[0m [38;5;242m//[0m[38;5;242m Optionally handle connection events[0m
[38;5;238m  95[0m   [38;5;238mâ”‚[0m [38;5;203mtry[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m  96[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231mredis[0m[38;5;231m.[0m[38;5;231mon[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mconnect[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;231m([0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m  97[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;149mconsole[0m[38;5;231m.[0m[38;5;81mlog[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mConnected to Redis[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m  98[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m  99[0m   [38;5;238mâ”‚[0m [38;5;231m}[0m[38;5;231m [0m[38;5;203mcatch[0m[38;5;231m [0m[38;5;231m([0m[38;5;231merror[0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 100[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;149mconsole[0m[38;5;231m.[0m[38;5;81merror[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mError connecting to Redis:[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;231merror[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 101[0m   [38;5;238mâ”‚[0m [38;5;231m}[0m
[38;5;238m 102[0m   [38;5;238mâ”‚[0m 
[38;5;238m 103[0m   [38;5;238mâ”‚[0m [38;5;242m//[0m[38;5;242m Remember to gracefully close the Redis connection when your app exits[0m
[38;5;238m 104[0m   [38;5;238mâ”‚[0m [38;5;149mprocess[0m[38;5;231m.[0m[38;5;231mon[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mexit[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;231m([0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 105[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231mredis[0m[38;5;231m.[0m[38;5;231mquit[0m[38;5;231m()[0m[38;5;231m;[0m
[38;5;238m 106[0m   [38;5;238mâ”‚[0m [38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 107[0m [31m_[0m [38;5;238mâ”‚[0m [38;5;231mclient[0m[38;5;231m.[0m[38;5;231mconnect[0m[38;5;231m()[0m[38;5;231m;[0m
[38;5;238m 108[0m   [38;5;238mâ”‚[0m [38;5;242m//[0m[38;5;242mALLOW CORS FOR LOAD BALANCER[0m
[38;5;238m 109[0m   [38;5;238mâ”‚[0m [38;5;231mapp[0m[38;5;231m.[0m[38;5;231muse[0m[38;5;231m([0m
[38;5;238m 110[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231mcors[0m[38;5;231m([0m[38;5;231m{[0m
[38;5;238m 111[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231morigin[0m[38;5;231m:[0m[38;5;231m [0m[38;5;186m"[0m[38;5;186m*[0m[38;5;186m"[0m[38;5;231m,[0m
[38;5;238m 112[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m}[0m[38;5;231m)[0m
[38;5;238m 113[0m   [38;5;238mâ”‚[0m [38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 114[0m   [38;5;238mâ”‚[0m 
[38;5;238m 115[0m   [38;5;238mâ”‚[0m [38;5;231mapp[0m[38;5;231m.[0m[38;5;231muse[0m[38;5;231m([0m[38;5;231mmorgan[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mcombined[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 116[0m   [38;5;238mâ”‚[0m [38;5;231mapp[0m[38;5;231m.[0m[38;5;231muse[0m[38;5;231m([0m[38;5;231mcompression[0m[38;5;231m()[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 117[0m   [38;5;238mâ”‚[0m [38;5;231mapp[0m[38;5;231m.[0m[38;5;231muse[0m[38;5;231m([0m[38;5;231mbodyParser[0m[38;5;231m.[0m[38;5;231mjson[0m[38;5;231m()[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 118[0m [33m~[0m [38;5;238mâ”‚[0m [38;5;231mapp[0m[38;5;231m.[0m[38;5;231muse[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186m/docs[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;231mswaggerUi[0m[38;5;231m.[0m[38;5;231mserve[0m[38;5;231m, [0m[38;5;231mswaggerUi[0m[38;5;231m.[0m[38;5;231msetup[0m[38;5;231m([0m[38;5;231mswaggerDocument[0m[38;5;231m)[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 119[0m   [38;5;238mâ”‚[0m [38;5;231mapp[0m[38;5;231m.[0m[38;5;231mget[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186m/[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;231m([0m[38;5;208mreq[0m[38;5;231m,[0m[38;5;231m [0m[38;5;208mres[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 120[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231mres[0m[38;5;231m.[0m[38;5;231msend[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mHi, Blackbox, grab some data! omnomnomnom...[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 121[0m   [38;5;238mâ”‚[0m [38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 122[0m   [38;5;238mâ”‚[0m 
[38;5;238m 123[0m   [38;5;238mâ”‚[0m [38;5;242m//[0m[38;5;242m Function to sanitize collection names[0m
[38;5;238m 124[0m   [38;5;238mâ”‚[0m [38;5;81mconst[0m[38;5;231m [0m[38;5;149msanitizeName[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231m([0m[38;5;208mname[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 125[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;203mreturn[0m[38;5;231m [0m[38;5;231mname[0m
[38;5;238m 126[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m.[0m[38;5;231mnormalize[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mNFD[0m[38;5;186m"[0m[38;5;231m)[0m
[38;5;238m 127[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m.[0m[38;5;231mreplace[0m[38;5;231m([0m[38;5;214m/[0m[38;5;141m[[0m[38;5;141m\u0300[0m[38;5;141m-[0m[38;5;141m\u036f[0m[38;5;141m][0m[38;5;214m/[0m[38;5;203mg[0m[38;5;231m, [0m[38;5;186m"[0m[38;5;186m"[0m[38;5;231m)[0m
[38;5;238m 128[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m.[0m[38;5;231mreplace[0m[38;5;231m([0m[38;5;214m/[0m[38;5;141m\s[0m[38;5;203m+[0m[38;5;214m/[0m[38;5;203mg[0m[38;5;231m, [0m[38;5;186m"[0m[38;5;186m"[0m[38;5;231m)[0m
[38;5;238m 129[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m.[0m[38;5;231mreplace[0m[38;5;231m([0m[38;5;214m/[0m[38;5;141m[[0m[38;5;203m^[0m[38;5;141ma[0m[38;5;141m-[0m[38;5;141mz[0m[38;5;141mA[0m[38;5;141m-[0m[38;5;141mZ[0m[38;5;141m0[0m[38;5;141m-[0m[38;5;141m9[0m[38;5;141m][0m[38;5;214m/[0m[38;5;203mg[0m[38;5;231m, [0m[38;5;186m"[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 130[0m   [38;5;238mâ”‚[0m [38;5;231m}[0m[38;5;231m;[0m
[38;5;238m 131[0m   [38;5;238mâ”‚[0m [38;5;242m//[0m[38;5;242m Middleware for file uploads with structured directory[0m
[38;5;238m 132[0m   [38;5;238mâ”‚[0m [38;5;81mconst[0m[38;5;231m [0m[38;5;231mstorage[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mmulter[0m[38;5;231m.[0m[38;5;231mdiskStorage[0m[38;5;231m([0m[38;5;231m{[0m
[38;5;238m 133[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;149mdestination[0m[38;5;231m:[0m[38;5;231m [0m[38;5;81masync[0m[38;5;231m [0m[38;5;81mfunction[0m[38;5;231m [0m[38;5;231m([0m[38;5;208mreq[0m[38;5;231m,[0m[38;5;231m [0m[38;5;208mfile[0m[38;5;231m,[0m[38;5;231m [0m[38;5;208mcb[0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 134[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;242m//[0m[38;5;242m Generate a UUID for the subdirectory[0m
[38;5;238m 135[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231muniqueSubdir[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231muuidv4[0m[38;5;231m()[0m[38;5;231m;[0m
[38;5;238m 136[0m   [38;5;238mâ”‚[0m 
[38;5;238m 137[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mdir[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;203m`[0m[38;5;186mu[0m[38;5;186mp[0m[38;5;186ml[0m[38;5;186mo[0m[38;5;186ma[0m[38;5;186md[0m[38;5;186ms[0m[38;5;186m/[0m[38;5;203m${[0m[38;5;231muniqueSubdir[0m[38;5;203m}[0m[38;5;186m/[0m[38;5;203m${[0m[38;5;231mreq[0m[38;5;231m.[0m[38;5;231mget[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mhost[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;203m}[0m[38;5;203m`[0m[38;5;231m;[0m
[38;5;238m 138[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;203mawait[0m[38;5;231m [0m[38;5;231mfs[0m[38;5;231m.[0m[38;5;231mmkdir[0m[38;5;231m([0m[38;5;231mdir[0m[38;5;231m, [0m[38;5;231m{[0m[38;5;231m [0m[38;5;231mrecursive[0m[38;5;231m:[0m[38;5;231m [0m[38;5;141mtrue[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 139[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231mcb[0m[38;5;231m([0m[38;5;141mnull[0m[38;5;231m, [0m[38;5;231mdir[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 140[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m 141[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;149mfilename[0m[38;5;231m:[0m[38;5;231m [0m[38;5;81mfunction[0m[38;5;231m [0m[38;5;231m([0m[38;5;208mreq[0m[38;5;231m,[0m[38;5;231m [0m[38;5;208mfile[0m[38;5;231m,[0m[38;5;231m [0m[38;5;208mcb[0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 142[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231mcb[0m[38;5;231m([0m[38;5;141mnull[0m[38;5;231m, [0m[38;5;231mfile[0m[38;5;231m.[0m[38;5;231moriginalname[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 143[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m 144[0m   [38;5;238mâ”‚[0m [38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 145[0m   [38;5;238mâ”‚[0m 
[38;5;238m 146[0m   [38;5;238mâ”‚[0m [38;5;242m//[0m[38;5;242m Middleware for photo uploads with structured naming[0m
[38;5;238m 147[0m   [38;5;238mâ”‚[0m [38;5;81mconst[0m[38;5;231m [0m[38;5;231mphotoStorage[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mmulter[0m[38;5;231m.[0m[38;5;231mdiskStorage[0m[38;5;231m([0m[38;5;231m{[0m
[38;5;238m 148[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;149mdestination[0m[38;5;231m:[0m[38;5;231m [0m[38;5;81mfunction[0m[38;5;231m [0m[38;5;231m([0m[38;5;208mreq[0m[38;5;231m,[0m[38;5;231m [0m[38;5;208mfile[0m[38;5;231m,[0m[38;5;231m [0m[38;5;208mcb[0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 149[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mdir[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mpath[0m[38;5;231m.[0m[38;5;231mjoin[0m[38;5;231m([0m[38;5;149m__dirname[0m[38;5;231m, [0m[38;5;186m"[0m[38;5;186mphotos[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 150[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231mcb[0m[38;5;231m([0m[38;5;141mnull[0m[38;5;231m, [0m[38;5;231mdir[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 151[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m 152[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;149mfilename[0m[38;5;231m:[0m[38;5;231m [0m[38;5;81mfunction[0m[38;5;231m [0m[38;5;231m([0m[38;5;208mreq[0m[38;5;231m,[0m[38;5;231m [0m[38;5;208mfile[0m[38;5;231m,[0m[38;5;231m [0m[38;5;208mcb[0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 153[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mcollectionName[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;81mdecodeURIComponent[0m[38;5;231m([0m[38;5;231mreq[0m[38;5;231m.[0m[38;5;231mparams[0m[38;5;231m.[0m[38;5;231mcollectionName[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 154[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231msanitizedCollectionName[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231msanitizeName[0m[38;5;231m([0m[38;5;231mcollectionName[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 155[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mextension[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mpath[0m[38;5;231m.[0m[38;5;231mextname[0m[38;5;231m([0m[38;5;231mfile[0m[38;5;231m.[0m[38;5;231moriginalname[0m[38;5;231m)[0m[38;5;231m;[0m[38;5;231m [0m[38;5;242m//[0m[38;5;242m Get the extension of the original fi[0m
[38;5;238m    [0m   [38;5;238mâ”‚[0m [38;5;242mle[0m
[38;5;238m 156[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mfilename[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;203m`[0m[38;5;203m${[0m[38;5;231msanitizedCollectionName[0m[38;5;203m}[0m[38;5;203m${[0m[38;5;231mextension[0m[38;5;203m}[0m[38;5;203m`[0m[38;5;231m;[0m[38;5;231m [0m[38;5;242m//[0m[38;5;242m Construct the filename using[0m
[38;5;238m    [0m   [38;5;238mâ”‚[0m [38;5;242m only the sanitized collection name and extension[0m
[38;5;238m 157[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231mcb[0m[38;5;231m([0m[38;5;141mnull[0m[38;5;231m, [0m[38;5;231mfilename[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 158[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m 159[0m   [38;5;238mâ”‚[0m [38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 160[0m   [38;5;238mâ”‚[0m 
[38;5;238m 161[0m   [38;5;238mâ”‚[0m [38;5;81mconst[0m[38;5;231m [0m[38;5;231mupload_photo[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mmulter[0m[38;5;231m([0m[38;5;231m{[0m[38;5;231m [0m[38;5;231mstorage[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231mphotoStorage[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 162[0m   [38;5;238mâ”‚[0m 
[38;5;238m 163[0m   [38;5;238mâ”‚[0m [38;5;81mconst[0m[38;5;231m [0m[38;5;231mupload[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mmulter[0m[38;5;231m([0m[38;5;231m{[0m[38;5;231m [0m[38;5;231mstorage[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231mstorage[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 164[0m   [38;5;238mâ”‚[0m 
[38;5;238m 165[0m   [38;5;238mâ”‚[0m [38;5;242m//[0m[38;5;242m Middleware to track start time of request[0m
[38;5;238m 166[0m   [38;5;238mâ”‚[0m [38;5;231mapp[0m[38;5;231m.[0m[38;5;231muse[0m[38;5;231m([0m[38;5;231m([0m[38;5;208mreq[0m[38;5;231m,[0m[38;5;231m [0m[38;5;208mres[0m[38;5;231m,[0m[38;5;231m [0m[38;5;208mnext[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 167[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231mreq[0m[38;5;231m.[0m[38;5;231mstartTime[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;149mDate[0m[38;5;231m.[0m[38;5;231mnow[0m[38;5;231m()[0m[38;5;231m;[0m
[38;5;238m 168[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231mnext[0m[38;5;231m()[0m[38;5;231m;[0m
[38;5;238m 169[0m   [38;5;238mâ”‚[0m [38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 170[0m   [38;5;238mâ”‚[0m 
[38;5;238m 171[0m   [38;5;238mâ”‚[0m [38;5;242m//[0m[38;5;242m Utility function to format time difference[0m
[38;5;238m 172[0m   [38;5;238mâ”‚[0m [38;5;81mfunction[0m[38;5;149m [0m[38;5;149mformatTimeDifference[0m[38;5;231m([0m[38;5;208mstartTime[0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 173[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mendTime[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;149mDate[0m[38;5;231m.[0m[38;5;231mnow[0m[38;5;231m()[0m[38;5;231m;[0m
[38;5;238m 174[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mdiff[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;203mnew[0m[38;5;231m [0m[38;5;149mDate[0m[38;5;231m([0m[38;5;231mendTime[0m[38;5;231m [0m[38;5;203m-[0m[38;5;231m [0m[38;5;231mstartTime[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 175[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mhh[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;149mString[0m[38;5;231m([0m[38;5;231mdiff[0m[38;5;231m.[0m[38;5;231mgetUTCHours[0m[38;5;231m()[0m[38;5;231m)[0m[38;5;231m.[0m[38;5;231mpadStart[0m[38;5;231m([0m[38;5;141m2[0m[38;5;231m, [0m[38;5;186m"[0m[38;5;186m0[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 176[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mmm[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;149mString[0m[38;5;231m([0m[38;5;231mdiff[0m[38;5;231m.[0m[38;5;231mgetUTCMinutes[0m[38;5;231m()[0m[38;5;231m)[0m[38;5;231m.[0m[38;5;231mpadStart[0m[38;5;231m([0m[38;5;141m2[0m[38;5;231m, [0m[38;5;186m"[0m[38;5;186m0[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 177[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mss[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;149mString[0m[38;5;231m([0m[38;5;231mdiff[0m[38;5;231m.[0m[38;5;231mgetUTCSeconds[0m[38;5;231m()[0m[38;5;231m)[0m[38;5;231m.[0m[38;5;231mpadStart[0m[38;5;231m([0m[38;5;141m2[0m[38;5;231m, [0m[38;5;186m"[0m[38;5;186m0[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 178[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;203mreturn[0m[38;5;231m [0m[38;5;203m`[0m[38;5;203m${[0m[38;5;231mhh[0m[38;5;203m}[0m[38;5;186m:[0m[38;5;203m${[0m[38;5;231mmm[0m[38;5;203m}[0m[38;5;186m:[0m[38;5;203m${[0m[38;5;231mss[0m[38;5;203m}[0m[38;5;203m`[0m[38;5;231m;[0m
[38;5;238m 179[0m   [38;5;238mâ”‚[0m [38;5;231m}[0m
[38;5;238m 180[0m   [38;5;238mâ”‚[0m 
[38;5;238m 181[0m   [38;5;238mâ”‚[0m [38;5;81mfunction[0m[38;5;149m [0m[38;5;149mlogEndpointInfo[0m[38;5;231m([0m[38;5;208mreq[0m[38;5;231m,[0m[38;5;149m [0m[38;5;208mres[0m[38;5;231m,[0m[38;5;149m [0m[38;5;208mendpoint[0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 182[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mtimeTaken[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mformatTimeDifference[0m[38;5;231m([0m[38;5;231mreq[0m[38;5;231m.[0m[38;5;231mstartTime[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 183[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mrequesterIP[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mreq[0m[38;5;231m.[0m[38;5;231mip[0m[38;5;231m;[0m[38;5;231m [0m[38;5;242m//[0m[38;5;242m Get the IP address of the requester[0m
[38;5;238m 184[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;149mconsole[0m[38;5;231m.[0m[38;5;81mlog[0m[38;5;231m([0m
[38;5;238m 185[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;203m`[0m[38;5;186mE[0m[38;5;186mn[0m[38;5;186md[0m[38;5;186mp[0m[38;5;186mo[0m[38;5;186mi[0m[38;5;186mn[0m[38;5;186mt[0m[38;5;186m:[0m[38;5;186m [0m[38;5;203m${[0m[38;5;231mendpoint[0m[38;5;203m}[0m[38;5;186m,[0m[38;5;186m [0m[38;5;186mR[0m[38;5;186me[0m[38;5;186mq[0m[38;5;186mu[0m[38;5;186me[0m[38;5;186ms[0m[38;5;186mt[0m[38;5;186m [0m[38;5;186mC[0m[38;5;186mo[0m[38;5;186mn[0m[38;5;186mt[0m[38;5;186me[0m[38;5;186mn[0m[38;5;186mt[0m[38;5;186ms[0m[38;5;186m:[0m[38;5;186m [0m[38;5;203m${[0m[38;5;149mJSON[0m[38;5;231m.[0m[38;5;231mstringify[0m[38;5;231m([0m
[38;5;238m 186[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231mreq[0m[38;5;231m.[0m[38;5;231mbody[0m
[38;5;238m 187[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m)[0m[38;5;203m}[0m[38;5;186m,[0m[38;5;186m [0m[38;5;186mR[0m[38;5;186me[0m[38;5;186mq[0m[38;5;186mu[0m[38;5;186me[0m[38;5;186ms[0m[38;5;186mt[0m[38;5;186me[0m[38;5;186mr[0m[38;5;186m [0m[38;5;186mI[0m[38;5;186mP[0m[38;5;186m:[0m[38;5;186m [0m[38;5;203m${[0m[38;5;231mrequesterIP[0m[38;5;203m}[0m[38;5;186m,[0m[38;5;186m [0m[38;5;186mT[0m[38;5;186mi[0m[38;5;186mm[0m[38;5;186me[0m[38;5;186m [0m[38;5;186mT[0m[38;5;186ma[0m[38;5;186mk[0m[38;5;186me[0m[38;5;186mn[0m[38;5;186m:[0m[38;5;186m [0m[38;5;203m${[0m[38;5;231mtimeTaken[0m[38;5;203m}[0m[38;5;203m`[0m
[38;5;238m 188[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 189[0m   [38;5;238mâ”‚[0m [38;5;231m}[0m
[38;5;238m 190[0m   [38;5;238mâ”‚[0m 
[38;5;238m 191[0m   [38;5;238mâ”‚[0m [38;5;242m//[0m[38;5;242m Error Handling[0m
[38;5;238m 192[0m   [38;5;238mâ”‚[0m [38;5;149mprocess[0m[38;5;231m.[0m[38;5;231mon[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186muncaughtException[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;231m([0m[38;5;208merr[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 193[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;149mconsole[0m[38;5;231m.[0m[38;5;81merror[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mUncaught Exception:[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;231merr[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 194[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231mlogError[0m[38;5;231m([0m[38;5;231merr[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 195[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;149mprocess[0m[38;5;231m.[0m[38;5;81mexit[0m[38;5;231m([0m[38;5;141m1[0m[38;5;231m)[0m[38;5;231m;[0m[38;5;231m [0m[38;5;242m//[0m[38;5;242m Exit the process with failure[0m
[38;5;238m 196[0m   [38;5;238mâ”‚[0m [38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 197[0m   [38;5;238mâ”‚[0m 
[38;5;238m 198[0m   [38;5;238mâ”‚[0m [38;5;149mprocess[0m[38;5;231m.[0m[38;5;231mon[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186munhandledRejection[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;231m([0m[38;5;208mreason[0m[38;5;231m,[0m[38;5;231m [0m[38;5;208mpromise[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 199[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;149mconsole[0m[38;5;231m.[0m[38;5;81merror[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mUnhandled Rejection at:[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;231mpromise[0m[38;5;231m, [0m[38;5;186m"[0m[38;5;186mreason:[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;231mreason[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 200[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231mlogError[0m[38;5;231m([0m[38;5;231mreason[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 201[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81msetTimeout[0m[38;5;231m([0m[38;5;231m([0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 202[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;149mprocess[0m[38;5;231m.[0m[38;5;81mexit[0m[38;5;231m([0m[38;5;141m1[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 203[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m}[0m[38;5;231m, [0m[38;5;141m1000[0m[38;5;231m)[0m[38;5;231m;[0m[38;5;231m [0m[38;5;242m//[0m[38;5;242m Delay for 1 second[0m
[38;5;238m 204[0m   [38;5;238mâ”‚[0m [38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 205[0m   [38;5;238mâ”‚[0m 
[38;5;238m 206[0m   [38;5;238mâ”‚[0m [38;5;81masync[0m[38;5;149m [0m[38;5;81mfunction[0m[38;5;149m [0m[38;5;149mlogError[0m[38;5;231m([0m[38;5;208merror[0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 207[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231merrorLog[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 208[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231mtimestamp[0m[38;5;231m:[0m[38;5;231m [0m[38;5;203mnew[0m[38;5;231m [0m[38;5;149mDate[0m[38;5;231m([0m[38;5;231m)[0m[38;5;231m.[0m[38;5;231mtoISOString[0m[38;5;231m()[0m[38;5;231m,[0m
[38;5;238m 209[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231mmessage[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231merror[0m[38;5;231m.[0m[38;5;231mmessage[0m[38;5;231m,[0m
[38;5;238m 210[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231mstack[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231merror[0m[38;5;231m.[0m[38;5;231mstack[0m[38;5;231m,[0m
[38;5;238m 211[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m}[0m[38;5;231m;[0m
[38;5;238m 212[0m   [38;5;238mâ”‚[0m 
[38;5;238m 213[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mlogsDir[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mpath[0m[38;5;231m.[0m[38;5;231mjoin[0m[38;5;231m([0m[38;5;149m__dirname[0m[38;5;231m, [0m[38;5;186m"[0m[38;5;186mlogs[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 214[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mlogFilePath[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mpath[0m[38;5;231m.[0m[38;5;231mjoin[0m[38;5;231m([0m[38;5;231mlogsDir[0m[38;5;231m, [0m[38;5;186m"[0m[38;5;186merror-log.json[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 215[0m   [38;5;238mâ”‚[0m 
[38;5;238m 216[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;203mtry[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 217[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;203mawait[0m[38;5;231m [0m[38;5;231mfs[0m[38;5;231m.[0m[38;5;231mmkdir[0m[38;5;231m([0m[38;5;231mlogsDir[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 218[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m}[0m[38;5;231m [0m[38;5;203mcatch[0m[38;5;231m [0m[38;5;231m([0m[38;5;231merr[0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 219[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;203mif[0m[38;5;231m [0m[38;5;231m([0m[38;5;231merr[0m[38;5;231m.[0m[38;5;231mcode[0m[38;5;231m [0m[38;5;203m!==[0m[38;5;231m [0m[38;5;186m"[0m[38;5;186mEEXIST[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 220[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;203mthrow[0m[38;5;231m [0m[38;5;231merr[0m[38;5;231m;[0m
[38;5;238m 221[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m}[0m
[38;5;238m 222[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m}[0m
[38;5;238m 223[0m   [38;5;238mâ”‚[0m 
[38;5;238m 224[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;203mtry[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 225[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;203mawait[0m[38;5;231m [0m[38;5;231mfs[0m[38;5;231m.[0m[38;5;231mappendFile[0m[38;5;231m([0m[38;5;231mlogFilePath[0m[38;5;231m, [0m[38;5;149mJSON[0m[38;5;231m.[0m[38;5;231mstringify[0m[38;5;231m([0m[38;5;231merrorLog[0m[38;5;231m)[0m[38;5;231m [0m[38;5;203m+[0m[38;5;231m [0m[38;5;231mos[0m[38;5;231m.[0m[38;5;231mEOL[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 226[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m}[0m[38;5;231m [0m[38;5;203mcatch[0m[38;5;231m [0m[38;5;231m([0m[38;5;231merr[0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 227[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;149mconsole[0m[38;5;231m.[0m[38;5;81merror[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mError while writing error log:[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;231merr[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 228[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m}[0m
[38;5;238m 229[0m   [38;5;238mâ”‚[0m 
[38;5;238m 230[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;149mconsole[0m[38;5;231m.[0m[38;5;81merror[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mError logged:[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;231merrorLog[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 231[0m   [38;5;238mâ”‚[0m 
[38;5;238m 232[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;203mreturn[0m[38;5;231m [0m[38;5;231merrorLog[0m[38;5;231m;[0m
[38;5;238m 233[0m   [38;5;238mâ”‚[0m [38;5;231m}[0m
[38;5;238m 234[0m   [38;5;238mâ”‚[0m 
[38;5;238m 235[0m   [38;5;238mâ”‚[0m [38;5;81masync[0m[38;5;149m [0m[38;5;81mfunction[0m[38;5;149m [0m[38;5;149msanitizeCollections[0m[38;5;231m([0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 236[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;203mtry[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 237[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;203mawait[0m[38;5;231m [0m[38;5;231mclient[0m[38;5;231m.[0m[38;5;231mconnect[0m[38;5;231m()[0m[38;5;231m;[0m
[38;5;238m 238[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mdb[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mclient[0m[38;5;231m.[0m[38;5;231mdb[0m[38;5;231m([0m[38;5;231mMESSAGE_DATABASE[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 239[0m   [38;5;238mâ”‚[0m 
[38;5;238m 240[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;242m//[0m[38;5;242m Fetch all collection names[0m
[38;5;238m 241[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mcollections[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;203mawait[0m[38;5;231m [0m[38;5;231mdb[0m[38;5;231m.[0m[38;5;231mlistCollections[0m[38;5;231m()[0m[38;5;231m.[0m[38;5;231mtoArray[0m[38;5;231m()[0m[38;5;231m;[0m
[38;5;238m 242[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mcollectionNames[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mcollections[0m[38;5;231m.[0m[38;5;231mmap[0m[38;5;231m([0m[38;5;231m([0m[38;5;208mc[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231mc[0m[38;5;231m.[0m[38;5;231mname[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 243[0m   [38;5;238mâ”‚[0m 
[38;5;238m 244[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mpromises[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mcollectionNames[0m[38;5;231m.[0m[38;5;231mmap[0m[38;5;231m([0m[38;5;81masync[0m[38;5;231m [0m[38;5;231m([0m[38;5;208mcollectionName[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 245[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;242m//[0m[38;5;242m Get the total count of documents that meet the criteria[0m
[38;5;238m 246[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mtotalCount[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;203mawait[0m[38;5;231m [0m[38;5;231mdb[0m[38;5;231m.[0m[38;5;231mcollection[0m[38;5;231m([0m[38;5;231mcollectionName[0m[38;5;231m)[0m[38;5;231m.[0m[38;5;231mcountDocuments[0m[38;5;231m([0m[38;5;231m{[0m
[38;5;238m 247[0m   [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;231mcontent[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231m{[0m[38;5;231m [0m[38;5;231m$exists[0m[38;5;231m:[0m[38;5;231m [0m[38;5;141mtrue[0m[38;5;231m,[0m[38;5;231m [0m[38;5;231m$ne[0m[38;5;231m:[0m[38;5;231m [0m[38;5;141mnull[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m 248[0m   [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;231msanitizedContent[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231m{[0m[38;5;231m [0m[38;5;231m$exists[0m[38;5;231m:[0m[38;5;231m [0m[38;5;141mfalse[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m 249[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 250[0m   [38;5;238mâ”‚[0m 
[38;5;238m 251[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;242m//[0m[38;5;242m Process all documents that meet the criteria using bulk updates[0m
[38;5;238m 252[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mbulkOps[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231m[[0m[38;5;231m][0m[38;5;231m;[0m
[38;5;238m 253[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mbatchSize[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;141m100[0m[38;5;231m;[0m[38;5;231m [0m[38;5;242m//[0m[38;5;242m Adjust the batch size as needed[0m
[38;5;238m 254[0m   [38;5;238mâ”‚[0m 
[38;5;238m 255[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;203mfor[0m[38;5;231m [0m[38;5;231m([0m[38;5;81mlet[0m[38;5;231m [0m[38;5;231mskip[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;141m0[0m[38;5;231m;[0m[38;5;231m [0m[38;5;231mskip[0m[38;5;231m [0m[38;5;203m<[0m[38;5;231m [0m[38;5;231mtotalCount[0m[38;5;231m;[0m[38;5;231m [0m[38;5;231mskip[0m[38;5;231m [0m[38;5;203m+=[0m[38;5;231m [0m[38;5;231mbatchSize[0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 256[0m   [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mdocuments[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;203mawait[0m[38;5;231m [0m[38;5;231mdb[0m
[38;5;238m 257[0m   [38;5;238mâ”‚[0m [38;5;231m          [0m[38;5;231m.[0m[38;5;231mcollection[0m[38;5;231m([0m[38;5;231mcollectionName[0m[38;5;231m)[0m
[38;5;238m 258[0m   [38;5;238mâ”‚[0m [38;5;231m          [0m[38;5;231m.[0m[38;5;231mfind[0m[38;5;231m([0m[38;5;231m{[0m
[38;5;238m 259[0m   [38;5;238mâ”‚[0m [38;5;231m            [0m[38;5;231mcontent[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231m{[0m[38;5;231m [0m[38;5;231m$exists[0m[38;5;231m:[0m[38;5;231m [0m[38;5;141mtrue[0m[38;5;231m,[0m[38;5;231m [0m[38;5;231m$ne[0m[38;5;231m:[0m[38;5;231m [0m[38;5;141mnull[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m 260[0m   [38;5;238mâ”‚[0m [38;5;231m            [0m[38;5;231msanitizedContent[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231m{[0m[38;5;231m [0m[38;5;231m$exists[0m[38;5;231m:[0m[38;5;231m [0m[38;5;141mfalse[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m 261[0m   [38;5;238mâ”‚[0m [38;5;231m          [0m[38;5;231m}[0m[38;5;231m)[0m
[38;5;238m 262[0m   [38;5;238mâ”‚[0m [38;5;231m          [0m[38;5;231m.[0m[38;5;231mskip[0m[38;5;231m([0m[38;5;231mskip[0m[38;5;231m)[0m
[38;5;238m 263[0m   [38;5;238mâ”‚[0m [38;5;231m          [0m[38;5;231m.[0m[38;5;231mlimit[0m[38;5;231m([0m[38;5;231mbatchSize[0m[38;5;231m)[0m
[38;5;238m 264[0m   [38;5;238mâ”‚[0m [38;5;231m          [0m[38;5;231m.[0m[38;5;231mtoArray[0m[38;5;231m()[0m[38;5;231m;[0m
[38;5;238m 265[0m   [38;5;238mâ”‚[0m 
[38;5;238m 266[0m   [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;203mfor[0m[38;5;231m [0m[38;5;231m([0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mdoc[0m[38;5;231m [0m[38;5;203mof[0m[38;5;231m [0m[38;5;231mdocuments[0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 267[0m   [38;5;238mâ”‚[0m [38;5;231m          [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231msanitizedContent[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mdiacritics[0m[38;5;231m.[0m[38;5;231mremove[0m[38;5;231m([0m[38;5;231mdoc[0m[38;5;231m.[0m[38;5;231mcontent[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 268[0m   [38;5;238mâ”‚[0m [38;5;231m          [0m[38;5;231mbulkOps[0m[38;5;231m.[0m[38;5;231mpush[0m[38;5;231m([0m[38;5;231m{[0m
[38;5;238m 269[0m   [38;5;238mâ”‚[0m [38;5;231m            [0m[38;5;231mupdateOne[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 270[0m   [38;5;238mâ”‚[0m [38;5;231m              [0m[38;5;231mfilter[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231m{[0m[38;5;231m [0m[38;5;231m_id[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231mdoc[0m[38;5;231m.[0m[38;5;231m_id[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m 271[0m   [38;5;238mâ”‚[0m [38;5;231m              [0m[38;5;231mupdate[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231m{[0m[38;5;231m [0m[38;5;231m$set[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231m{[0m[38;5;231m [0m[38;5;231msanitizedContent[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m 272[0m   [38;5;238mâ”‚[0m [38;5;231m            [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m 273[0m   [38;5;238mâ”‚[0m [38;5;231m          [0m[38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 274[0m   [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;231m}[0m
[38;5;238m 275[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m}[0m
[38;5;238m 276[0m   [38;5;238mâ”‚[0m 
[38;5;238m 277[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;203mif[0m[38;5;231m [0m[38;5;231m([0m[38;5;231mbulkOps[0m[38;5;231m.[0m[38;5;231mlength[0m[38;5;231m [0m[38;5;203m>[0m[38;5;231m [0m[38;5;141m0[0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 278[0m   [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;203mawait[0m[38;5;231m [0m[38;5;231mdb[0m[38;5;231m.[0m[38;5;231mcollection[0m[38;5;231m([0m[38;5;231mcollectionName[0m[38;5;231m)[0m[38;5;231m.[0m[38;5;231mbulkWrite[0m[38;5;231m([0m[38;5;231mbulkOps[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 279[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m}[0m
[38;5;238m 280[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 281[0m   [38;5;238mâ”‚[0m 
[38;5;238m 282[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;242m//[0m[38;5;242m Execute all promises in parallel[0m
[38;5;238m 283[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;203mawait[0m[38;5;231m [0m[38;5;149mPromise[0m[38;5;231m.[0m[38;5;231mall[0m[38;5;231m([0m[38;5;231mpromises[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 284[0m   [38;5;238mâ”‚[0m 
[38;5;238m 285[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;149mconsole[0m[38;5;231m.[0m[38;5;81mlog[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mCollections sanitized successfully.[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 286[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m}[0m[38;5;231m [0m[38;5;203mcatch[0m[38;5;231m [0m[38;5;231m([0m[38;5;231merror[0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 287[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;149mconsole[0m[38;5;231m.[0m[38;5;81merror[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mError during sanitization:[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;231merror[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 288[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m}[0m
[38;5;238m 289[0m   [38;5;238mâ”‚[0m [38;5;231m}[0m
[38;5;238m 290[0m   [38;5;238mâ”‚[0m 
[38;5;238m 291[0m   [38;5;238mâ”‚[0m [38;5;242m//[0m[38;5;242m Start the sanitization process when the server starts[0m
[38;5;238m 292[0m   [38;5;238mâ”‚[0m [38;5;231msanitizeCollections[0m[38;5;231m()[0m[38;5;231m;[0m
[38;5;238m 293[0m   [38;5;238mâ”‚[0m [38;5;81masync[0m[38;5;149m [0m[38;5;81mfunction[0m[38;5;149m [0m[38;5;149mupdateCollectionsCache[0m[38;5;231m([0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 294[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mdb[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mclient[0m[38;5;231m.[0m[38;5;231mdb[0m[38;5;231m([0m[38;5;231mMESSAGE_DATABASE[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 295[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mcollections[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;203mawait[0m[38;5;231m [0m[38;5;231mdb[0m[38;5;231m.[0m[38;5;231mlistCollections[0m[38;5;231m()[0m[38;5;231m.[0m[38;5;231mtoArray[0m[38;5;231m()[0m[38;5;231m;[0m
[38;5;238m 296[0m   [38;5;238mâ”‚[0m 
[38;5;238m 297[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mlet[0m[38;5;231m [0m[38;5;231mcollectionsData[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231m[[0m[38;5;231m][0m[38;5;231m;[0m
[38;5;238m 298[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;203mfor[0m[38;5;231m [0m[38;5;231m([0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mcollection[0m[38;5;231m [0m[38;5;203mof[0m[38;5;231m [0m[38;5;231mcollections[0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 299[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;242m//[0m[38;5;242m Skip system.profile and other collections you want to exclude[0m
[38;5;238m 300[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;203mif[0m[38;5;231m [0m[38;5;231m([0m[38;5;231mcollection[0m[38;5;231m.[0m[38;5;231mname[0m[38;5;231m [0m[38;5;203m===[0m[38;5;231m [0m[38;5;186m"[0m[38;5;186msystem.profile[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 301[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;203mcontinue[0m[38;5;231m;[0m
[38;5;238m 302[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m}[0m
[38;5;238m 303[0m   [38;5;238mâ”‚[0m 
[38;5;238m 304[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mcount[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;203mawait[0m[38;5;231m [0m[38;5;231mdb[0m[38;5;231m.[0m[38;5;231mcollection[0m[38;5;231m([0m[38;5;231mcollection[0m[38;5;231m.[0m[38;5;231mname[0m[38;5;231m)[0m[38;5;231m.[0m[38;5;231mcountDocuments[0m[38;5;231m()[0m[38;5;231m;[0m
[38;5;238m 305[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231mcollectionsData[0m[38;5;231m.[0m[38;5;231mpush[0m[38;5;231m([0m[38;5;231m{[0m
[38;5;238m 306[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231mname[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231mcollection[0m[38;5;231m.[0m[38;5;231mname[0m[38;5;231m,[0m
[38;5;238m 307[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231mmessageCount[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231mcount[0m[38;5;231m,[0m
[38;5;238m 308[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 309[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m}[0m
[38;5;238m 310[0m   [38;5;238mâ”‚[0m 
[38;5;238m 311[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;242m//[0m[38;5;242m Sort and store in Redis[0m
[38;5;238m 312[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231msortedByCount[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231m[[0m[38;5;203m...[0m[38;5;231mcollectionsData[0m[38;5;231m][0m[38;5;231m.[0m[38;5;231msort[0m[38;5;231m([0m
[38;5;238m 313[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m([0m[38;5;208ma[0m[38;5;231m,[0m[38;5;231m [0m[38;5;208mb[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231mb[0m[38;5;231m.[0m[38;5;231mmessageCount[0m[38;5;231m [0m[38;5;203m-[0m[38;5;231m [0m[38;5;231ma[0m[38;5;231m.[0m[38;5;231mmessageCount[0m
[38;5;238m 314[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 315[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231msortedAlphabetically[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231m[[0m[38;5;203m...[0m[38;5;231mcollectionsData[0m[38;5;231m][0m[38;5;231m.[0m[38;5;231msort[0m[38;5;231m([0m[38;5;231m([0m[38;5;208ma[0m[38;5;231m,[0m[38;5;231m [0m[38;5;208mb[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m
[38;5;238m 316[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231ma[0m[38;5;231m.[0m[38;5;231mname[0m[38;5;231m.[0m[38;5;231mlocaleCompare[0m[38;5;231m([0m[38;5;231mb[0m[38;5;231m.[0m[38;5;231mname[0m[38;5;231m)[0m
[38;5;238m 317[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 318[0m   [38;5;238mâ”‚[0m 
[38;5;238m 319[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;242m//[0m[38;5;242m Use JSON.stringify to store array data as a string[0m
[38;5;238m 320[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;203mawait[0m[38;5;231m [0m[38;5;231mredis[0m[38;5;231m.[0m[38;5;231mset[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mcollections[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;149mJSON[0m[38;5;231m.[0m[38;5;231mstringify[0m[38;5;231m([0m[38;5;231msortedByCount[0m[38;5;231m)[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 321[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;203mawait[0m[38;5;231m [0m[38;5;231mredis[0m[38;5;231m.[0m[38;5;231mset[0m[38;5;231m([0m
[38;5;238m 322[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;186m"[0m[38;5;186mcollectionsAlphabetical[0m[38;5;186m"[0m[38;5;231m,[0m
[38;5;238m 323[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;149mJSON[0m[38;5;231m.[0m[38;5;231mstringify[0m[38;5;231m([0m[38;5;231msortedAlphabetically[0m[38;5;231m)[0m
[38;5;238m 324[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 325[0m   [38;5;238mâ”‚[0m [38;5;231m}[0m
[38;5;238m 326[0m   [38;5;238mâ”‚[0m 
[38;5;238m 327[0m   [38;5;238mâ”‚[0m [38;5;242m//[0m[38;5;242m Initial cache population[0m
[38;5;238m 328[0m   [38;5;238mâ”‚[0m [38;5;231mupdateCollectionsCache[0m[38;5;231m()[0m[38;5;231m;[0m
[38;5;238m 329[0m   [38;5;238mâ”‚[0m 
[38;5;238m 330[0m   [38;5;238mâ”‚[0m [38;5;242m//[0m[38;5;242m Set an interval to update the cache every minute[0m
[38;5;238m 331[0m   [38;5;238mâ”‚[0m [38;5;81msetInterval[0m[38;5;231m([0m[38;5;231mupdateCollectionsCache[0m[38;5;231m, [0m[38;5;141m5000[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 332[0m   [38;5;238mâ”‚[0m 
[38;5;238m 333[0m   [38;5;238mâ”‚[0m [38;5;242m//[0m[38;5;242m Endpoint to get collections[0m
[38;5;238m 334[0m   [38;5;238mâ”‚[0m [38;5;231mapp[0m[38;5;231m.[0m[38;5;231mget[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186m/collections[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;81masync[0m[38;5;231m [0m[38;5;231m([0m[38;5;208mreq[0m[38;5;231m,[0m[38;5;231m [0m[38;5;208mres[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 335[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231mlogEndpointInfo[0m[38;5;231m([0m[38;5;231mreq[0m[38;5;231m, [0m[38;5;231mres[0m[38;5;231m, [0m[38;5;186m"[0m[38;5;186mGET /collections[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 336[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;203mtry[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 337[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mlet[0m[38;5;231m [0m[38;5;231mcachedData[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;141mnull[0m[38;5;231m;[0m
[38;5;238m 338[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;203mtry[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 339[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231mcachedData[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;203mawait[0m[38;5;231m [0m[38;5;231mredis[0m[38;5;231m.[0m[38;5;231mget[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mcollections[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 340[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m}[0m[38;5;231m [0m[38;5;203mcatch[0m[38;5;231m [0m[38;5;231m([0m[38;5;231mredisError[0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 341[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;149mconsole[0m[38;5;231m.[0m[38;5;81merror[0m[38;5;231m([0m
[38;5;238m 342[0m   [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;186m"[0m[38;5;186mRedis error, falling back to database:[0m[38;5;186m"[0m[38;5;231m,[0m
[38;5;238m 343[0m   [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;231mredisError[0m[38;5;231m.[0m[38;5;231mmessage[0m
[38;5;238m 344[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 345[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m}[0m
[38;5;238m 346[0m   [38;5;238mâ”‚[0m 
[38;5;238m 347[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;203mif[0m[38;5;231m [0m[38;5;231m([0m[38;5;231mcachedData[0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 348[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;203mreturn[0m[38;5;231m [0m[38;5;231mres[0m[38;5;231m.[0m[38;5;231mstatus[0m[38;5;231m([0m[38;5;141m200[0m[38;5;231m)[0m[38;5;231m.[0m[38;5;231mjson[0m[38;5;231m([0m[38;5;149mJSON[0m[38;5;231m.[0m[38;5;231mparse[0m[38;5;231m([0m[38;5;231mcachedData[0m[38;5;231m)[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 349[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m}[0m
[38;5;238m 350[0m   [38;5;238mâ”‚[0m 
[38;5;238m 351[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;242m//[0m[38;5;242m Assuming `db` is your MongoDB database instance[0m
[38;5;238m 352[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mcollections[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;203mawait[0m[38;5;231m [0m[38;5;231mdb[0m[38;5;231m.[0m[38;5;231mlistCollections[0m[38;5;231m()[0m[38;5;231m.[0m[38;5;231mtoArray[0m[38;5;231m()[0m[38;5;231m;[0m
[38;5;238m 353[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mcollectionNames[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mcollections[0m[38;5;231m.[0m[38;5;231mmap[0m[38;5;231m([0m[38;5;231m([0m[38;5;208mc[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231mc[0m[38;5;231m.[0m[38;5;231mname[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 354[0m   [38;5;238mâ”‚[0m 
[38;5;238m 355[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;203mtry[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 356[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;203mawait[0m[38;5;231m [0m[38;5;231mredis[0m[38;5;231m.[0m[38;5;231mset[0m[38;5;231m([0m
[38;5;238m 357[0m   [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;186m"[0m[38;5;186mcollections[0m[38;5;186m"[0m[38;5;231m,[0m
[38;5;238m 358[0m   [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;149mJSON[0m[38;5;231m.[0m[38;5;231mstringify[0m[38;5;231m([0m[38;5;231mcollectionNames[0m[38;5;231m)[0m[38;5;231m,[0m
[38;5;238m 359[0m   [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;186m"[0m[38;5;186mEX[0m[38;5;186m"[0m[38;5;231m,[0m
[38;5;238m 360[0m   [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;141m36000[0m
[38;5;238m 361[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 362[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m}[0m[38;5;231m [0m[38;5;203mcatch[0m[38;5;231m [0m[38;5;231m([0m[38;5;231mredisError[0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 363[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;149mconsole[0m[38;5;231m.[0m[38;5;81merror[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mFailed to save data to Redis:[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;231mredisError[0m[38;5;231m.[0m[38;5;231mmessage[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 364[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m}[0m
[38;5;238m 365[0m   [38;5;238mâ”‚[0m 
[38;5;238m 366[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;203mif[0m[38;5;231m [0m[38;5;231m([0m[38;5;231mcollectionNames[0m[38;5;231m.[0m[38;5;231mlength[0m[38;5;231m [0m[38;5;203m>[0m[38;5;231m [0m[38;5;141m0[0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 367[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231mres[0m[38;5;231m.[0m[38;5;231mstatus[0m[38;5;231m([0m[38;5;141m200[0m[38;5;231m)[0m[38;5;231m.[0m[38;5;231mjson[0m[38;5;231m([0m[38;5;231mcollectionNames[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 368[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m}[0m[38;5;231m [0m[38;5;203melse[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 369[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231mres[0m[38;5;231m.[0m[38;5;231mstatus[0m[38;5;231m([0m[38;5;141m404[0m[38;5;231m)[0m[38;5;231m.[0m[38;5;231msend[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mNo data found[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 370[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m}[0m
[38;5;238m 371[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m}[0m[38;5;231m [0m[38;5;203mcatch[0m[38;5;231m [0m[38;5;231m([0m[38;5;231merror[0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 372[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;149mconsole[0m[38;5;231m.[0m[38;5;81merror[0m[38;5;231m([0m[38;5;231merror[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 373[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231mres[0m[38;5;231m.[0m[38;5;231mstatus[0m[38;5;231m([0m[38;5;141m500[0m[38;5;231m)[0m[38;5;231m.[0m[38;5;231msend[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mInternal Server Error[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 374[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m}[0m
[38;5;238m 375[0m   [38;5;238mâ”‚[0m [38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 376[0m   [38;5;238mâ”‚[0m 
[38;5;238m 377[0m   [38;5;238mâ”‚[0m [38;5;231mapp[0m[38;5;231m.[0m[38;5;231mget[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186m/collections/alphabetical[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;81masync[0m[38;5;231m [0m[38;5;231m([0m[38;5;208mreq[0m[38;5;231m,[0m[38;5;231m [0m[38;5;208mres[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 378[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231mlogEndpointInfo[0m[38;5;231m([0m[38;5;231mreq[0m[38;5;231m, [0m[38;5;231mres[0m[38;5;231m, [0m[38;5;186m"[0m[38;5;186mGET /collections/alphabetical[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 379[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;203mtry[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 380[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mlet[0m[38;5;231m [0m[38;5;231mcachedData[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;141mnull[0m[38;5;231m;[0m
[38;5;238m 381[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;203mtry[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 382[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231mcachedData[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;203mawait[0m[38;5;231m [0m[38;5;231mredis[0m[38;5;231m.[0m[38;5;231mget[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mcollectionsAlphabetical[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 383[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m}[0m[38;5;231m [0m[38;5;203mcatch[0m[38;5;231m [0m[38;5;231m([0m[38;5;231mredisError[0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 384[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;149mconsole[0m[38;5;231m.[0m[38;5;81merror[0m[38;5;231m([0m
[38;5;238m 385[0m   [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;186m"[0m[38;5;186mRedis error, falling back to database:[0m[38;5;186m"[0m[38;5;231m,[0m
[38;5;238m 386[0m   [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;231mredisError[0m[38;5;231m.[0m[38;5;231mmessage[0m
[38;5;238m 387[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 388[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m}[0m
[38;5;238m 389[0m   [38;5;238mâ”‚[0m 
[38;5;238m 390[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;203mif[0m[38;5;231m [0m[38;5;231m([0m[38;5;231mcachedData[0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 391[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;203mreturn[0m[38;5;231m [0m[38;5;231mres[0m[38;5;231m.[0m[38;5;231mstatus[0m[38;5;231m([0m[38;5;141m200[0m[38;5;231m)[0m[38;5;231m.[0m[38;5;231mjson[0m[38;5;231m([0m[38;5;149mJSON[0m[38;5;231m.[0m[38;5;231mparse[0m[38;5;231m([0m[38;5;231mcachedData[0m[38;5;231m)[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 392[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m}[0m
[38;5;238m 393[0m   [38;5;238mâ”‚[0m 
[38;5;238m 394[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;242m//[0m[38;5;242m Assuming `db` is your MongoDB database instance and collections have names to sort alph[0m
[38;5;238m    [0m   [38;5;238mâ”‚[0m [38;5;242mabetically[0m
[38;5;238m 395[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mcollections[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;203mawait[0m[38;5;231m [0m[38;5;231mdb[0m[38;5;231m.[0m[38;5;231mlistCollections[0m[38;5;231m()[0m[38;5;231m.[0m[38;5;231mtoArray[0m[38;5;231m()[0m[38;5;231m;[0m
[38;5;238m 396[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mcollectionNames[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mcollections[0m[38;5;231m.[0m[38;5;231mmap[0m[38;5;231m([0m[38;5;231m([0m[38;5;208mc[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231mc[0m[38;5;231m.[0m[38;5;231mname[0m[38;5;231m)[0m[38;5;231m.[0m[38;5;231msort[0m[38;5;231m()[0m[38;5;231m;[0m
[38;5;238m 397[0m   [38;5;238mâ”‚[0m 
[38;5;238m 398[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;203mtry[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 399[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;203mawait[0m[38;5;231m [0m[38;5;231mredis[0m[38;5;231m.[0m[38;5;231mset[0m[38;5;231m([0m
[38;5;238m 400[0m   [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;186m"[0m[38;5;186mcollectionsAlphabetical[0m[38;5;186m"[0m[38;5;231m,[0m
[38;5;238m 401[0m   [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;149mJSON[0m[38;5;231m.[0m[38;5;231mstringify[0m[38;5;231m([0m[38;5;231mcollectionNames[0m[38;5;231m)[0m[38;5;231m,[0m
[38;5;238m 402[0m   [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;186m"[0m[38;5;186mEX[0m[38;5;186m"[0m[38;5;231m,[0m
[38;5;238m 403[0m   [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;141m36000[0m
[38;5;238m 404[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 405[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m}[0m[38;5;231m [0m[38;5;203mcatch[0m[38;5;231m [0m[38;5;231m([0m[38;5;231mredisError[0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 406[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;149mconsole[0m[38;5;231m.[0m[38;5;81merror[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mFailed to save data to Redis:[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;231mredisError[0m[38;5;231m.[0m[38;5;231mmessage[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 407[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m}[0m
[38;5;238m 408[0m   [38;5;238mâ”‚[0m 
[38;5;238m 409[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;203mif[0m[38;5;231m [0m[38;5;231m([0m[38;5;231mcollectionNames[0m[38;5;231m.[0m[38;5;231mlength[0m[38;5;231m [0m[38;5;203m>[0m[38;5;231m [0m[38;5;141m0[0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 410[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231mres[0m[38;5;231m.[0m[38;5;231mstatus[0m[38;5;231m([0m[38;5;141m200[0m[38;5;231m)[0m[38;5;231m.[0m[38;5;231mjson[0m[38;5;231m([0m[38;5;231mcollectionNames[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 411[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m}[0m[38;5;231m [0m[38;5;203melse[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 412[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231mres[0m[38;5;231m.[0m[38;5;231mstatus[0m[38;5;231m([0m[38;5;141m404[0m[38;5;231m)[0m[38;5;231m.[0m[38;5;231msend[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mNo data found[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 413[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m}[0m
[38;5;238m 414[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m}[0m[38;5;231m [0m[38;5;203mcatch[0m[38;5;231m [0m[38;5;231m([0m[38;5;231merror[0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 415[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;149mconsole[0m[38;5;231m.[0m[38;5;81merror[0m[38;5;231m([0m[38;5;231merror[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 416[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231mres[0m[38;5;231m.[0m[38;5;231mstatus[0m[38;5;231m([0m[38;5;141m500[0m[38;5;231m)[0m[38;5;231m.[0m[38;5;231msend[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mInternal Server Error[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 417[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m}[0m
[38;5;238m 418[0m   [38;5;238mâ”‚[0m [38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 419[0m   [38;5;238mâ”‚[0m 
[38;5;238m 420[0m   [38;5;238mâ”‚[0m [38;5;242m//[0m[38;5;242m Endpoint to get messages by collection name[0m
[38;5;238m 421[0m   [38;5;238mâ”‚[0m 
[38;5;238m 422[0m   [38;5;238mâ”‚[0m [38;5;231mapp[0m[38;5;231m.[0m[38;5;231mget[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186m/messages/:collectionName[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;81masync[0m[38;5;231m [0m[38;5;231m([0m[38;5;208mreq[0m[38;5;231m,[0m[38;5;231m [0m[38;5;208mres[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 423[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mcollectionName[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;81mdecodeURIComponent[0m[38;5;231m([0m[38;5;231mreq[0m[38;5;231m.[0m[38;5;231mparams[0m[38;5;231m.[0m[38;5;231mcollectionName[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 424[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mfromDate[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mreq[0m[38;5;231m.[0m[38;5;231mquery[0m[38;5;231m.[0m[38;5;231mfromDate[0m
[38;5;238m 425[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;203m?[0m[38;5;231m [0m[38;5;203mnew[0m[38;5;231m [0m[38;5;149mDate[0m[38;5;231m([0m[38;5;203m`[0m[38;5;203m${[0m[38;5;231mreq[0m[38;5;231m.[0m[38;5;231mquery[0m[38;5;231m.[0m[38;5;231mfromDate[0m[38;5;203m}[0m[38;5;186mT[0m[38;5;186m0[0m[38;5;186m0[0m[38;5;186m:[0m[38;5;186m0[0m[38;5;186m0[0m[38;5;186m:[0m[38;5;186m0[0m[38;5;186m0[0m[38;5;186mZ[0m[38;5;203m`[0m[38;5;231m)[0m[38;5;231m.[0m[38;5;231mgetTime[0m[38;5;231m()[0m
[38;5;238m 426[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m:[0m[38;5;231m [0m[38;5;141mnull[0m[38;5;231m;[0m
[38;5;238m 427[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mtoDate[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mreq[0m[38;5;231m.[0m[38;5;231mquery[0m[38;5;231m.[0m[38;5;231mtoDate[0m
[38;5;238m 428[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;203m?[0m[38;5;231m [0m[38;5;203mnew[0m[38;5;231m [0m[38;5;149mDate[0m[38;5;231m([0m[38;5;203m`[0m[38;5;203m${[0m[38;5;231mreq[0m[38;5;231m.[0m[38;5;231mquery[0m[38;5;231m.[0m[38;5;231mtoDate[0m[38;5;203m}[0m[38;5;186mT[0m[38;5;186m2[0m[38;5;186m3[0m[38;5;186m:[0m[38;5;186m5[0m[38;5;186m9[0m[38;5;186m:[0m[38;5;186m5[0m[38;5;186m9[0m[38;5;186mZ[0m[38;5;203m`[0m[38;5;231m)[0m[38;5;231m.[0m[38;5;231mgetTime[0m[38;5;231m()[0m
[38;5;238m 429[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m:[0m[38;5;231m [0m[38;5;141mnull[0m[38;5;231m;[0m
[38;5;238m 430[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mcacheKey[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;203m`[0m[38;5;186mm[0m[38;5;186me[0m[38;5;186ms[0m[38;5;186ms[0m[38;5;186ma[0m[38;5;186mg[0m[38;5;186me[0m[38;5;186ms[0m[38;5;186m-[0m[38;5;203m${[0m[38;5;231mcollectionName[0m[38;5;203m}[0m[38;5;186m-[0m[38;5;203m${[0m[38;5;231mfromDate[0m[38;5;203m}[0m[38;5;186m-[0m[38;5;203m${[0m[38;5;231mtoDate[0m[38;5;203m}[0m[38;5;203m`[0m[38;5;231m;[0m
[38;5;238m 431[0m   [38;5;238mâ”‚[0m 
[38;5;238m 432[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;203mtry[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 433[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;242m//[0m[38;5;242m Initialize variable to hold cached data or null[0m
[38;5;238m 434[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mlet[0m[38;5;231m [0m[38;5;231mcachedData[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;141mnull[0m[38;5;231m;[0m
[38;5;238m 435[0m   [38;5;238mâ”‚[0m 
[38;5;238m 436[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;203mtry[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 437[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;242m//[0m[38;5;242m Try to get data from Redis cache[0m
[38;5;238m 438[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231mcachedData[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;203mawait[0m[38;5;231m [0m[38;5;231mredis[0m[38;5;231m.[0m[38;5;231mget[0m[38;5;231m([0m[38;5;231mcacheKey[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 439[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m}[0m[38;5;231m [0m[38;5;203mcatch[0m[38;5;231m [0m[38;5;231m([0m[38;5;231mredisError[0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 440[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;149mconsole[0m[38;5;231m.[0m[38;5;81merror[0m[38;5;231m([0m
[38;5;238m 441[0m   [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;186m"[0m[38;5;186mRedis error, falling back to database:[0m[38;5;186m"[0m[38;5;231m,[0m
[38;5;238m 442[0m   [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;231mredisError[0m[38;5;231m.[0m[38;5;231mmessage[0m
[38;5;238m 443[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 444[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;242m//[0m[38;5;242m Don't return or throw; simply log the error and move on to fetching from the database[0m
[38;5;238m 445[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m}[0m
[38;5;238m 446[0m   [38;5;238mâ”‚[0m 
[38;5;238m 447[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;203mif[0m[38;5;231m [0m[38;5;231m([0m[38;5;231mcachedData[0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 448[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;203mreturn[0m[38;5;231m [0m[38;5;231mres[0m[38;5;231m.[0m[38;5;231mstatus[0m[38;5;231m([0m[38;5;141m200[0m[38;5;231m)[0m[38;5;231m.[0m[38;5;231mjson[0m[38;5;231m([0m[38;5;149mJSON[0m[38;5;231m.[0m[38;5;231mparse[0m[38;5;231m([0m[38;5;231mcachedData[0m[38;5;231m)[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 449[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m}[0m
[38;5;238m 450[0m   [38;5;238mâ”‚[0m 
[38;5;238m 451[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;149mconsole[0m[38;5;231m.[0m[38;5;81mlog[0m[38;5;231m([0m[38;5;203m`[0m[38;5;186mf[0m[38;5;186mr[0m[38;5;186mo[0m[38;5;186mm[0m[38;5;186mD[0m[38;5;186ma[0m[38;5;186mt[0m[38;5;186me[0m[38;5;186m [0m[38;5;186mt[0m[38;5;186mi[0m[38;5;186mm[0m[38;5;186me[0m[38;5;186ms[0m[38;5;186mt[0m[38;5;186ma[0m[38;5;186mm[0m[38;5;186mp[0m[38;5;186m:[0m[38;5;186m [0m[38;5;203m${[0m[38;5;231mfromDate[0m[38;5;203m}[0m[38;5;186m,[0m[38;5;186m [0m[38;5;186mt[0m[38;5;186mo[0m[38;5;186mD[0m[38;5;186ma[0m[38;5;186mt[0m[38;5;186me[0m[38;5;186m [0m[38;5;186mt[0m[38;5;186mi[0m[38;5;186mm[0m[38;5;186me[0m[38;5;186ms[0m[38;5;186mt[0m[38;5;186ma[0m[38;5;186mm[0m[38;5;186mp[0m[38;5;186m:[0m[38;5;186m [0m[38;5;203m${[0m[38;5;231mtoDate[0m[38;5;203m}[0m[38;5;203m`[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 452[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mdb[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mclient[0m[38;5;231m.[0m[38;5;231mdb[0m[38;5;231m([0m[38;5;231mMESSAGE_DATABASE[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 453[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mcollection[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mdb[0m[38;5;231m.[0m[38;5;231mcollection[0m[38;5;231m([0m[38;5;231mcollectionName[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 454[0m   [38;5;238mâ”‚[0m 
[38;5;238m 455[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mpipeline[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231m[[0m
[38;5;238m 456[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;203m...[0m[38;5;231m([0m[38;5;231mfromDate[0m[38;5;231m [0m[38;5;203m!==[0m[38;5;231m [0m[38;5;141mnull[0m[38;5;231m [0m[38;5;203m||[0m[38;5;231m [0m[38;5;231mtoDate[0m[38;5;231m [0m[38;5;203m!==[0m[38;5;231m [0m[38;5;141mnull[0m
[38;5;238m 457[0m   [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;203m?[0m[38;5;231m [0m[38;5;231m[[0m
[38;5;238m 458[0m   [38;5;238mâ”‚[0m [38;5;231m            [0m[38;5;231m{[0m
[38;5;238m 459[0m   [38;5;238mâ”‚[0m [38;5;231m              [0m[38;5;231m$match[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 460[0m   [38;5;238mâ”‚[0m [38;5;231m                [0m[38;5;203m...[0m[38;5;231m([0m[38;5;231mfromDate[0m[38;5;231m [0m[38;5;203m!==[0m[38;5;231m [0m[38;5;141mnull[0m[38;5;231m [0m[38;5;203m&&[0m[38;5;231m [0m[38;5;231m{[0m[38;5;231m [0m[38;5;231mtimestamp_ms[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231m{[0m[38;5;231m [0m[38;5;231m$gte[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231mfromDate[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m)[0m[38;5;231m,[0m
[38;5;238m 461[0m   [38;5;238mâ”‚[0m [38;5;231m                [0m[38;5;203m...[0m[38;5;231m([0m[38;5;231mtoDate[0m[38;5;231m [0m[38;5;203m!==[0m[38;5;231m [0m[38;5;141mnull[0m[38;5;231m [0m[38;5;203m&&[0m[38;5;231m [0m[38;5;231m{[0m[38;5;231m [0m[38;5;231mtimestamp_ms[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231m{[0m[38;5;231m [0m[38;5;231m$lte[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231mtoDate[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m)[0m[38;5;231m,[0m
[38;5;238m 462[0m   [38;5;238mâ”‚[0m [38;5;231m              [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m 463[0m   [38;5;238mâ”‚[0m [38;5;231m            [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m 464[0m   [38;5;238mâ”‚[0m [38;5;231m          [0m[38;5;231m][0m
[38;5;238m 465[0m   [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;203m:[0m[38;5;231m [0m[38;5;231m[[0m[38;5;231m][0m[38;5;231m)[0m[38;5;231m,[0m
[38;5;238m 466[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m{[0m[38;5;231m [0m[38;5;231m$sort[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231m{[0m[38;5;231m [0m[38;5;231mtimestamp_ms[0m[38;5;231m:[0m[38;5;231m [0m[38;5;141m1[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m 467[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m{[0m
[38;5;238m 468[0m   [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;231m$project[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 469[0m   [38;5;238mâ”‚[0m [38;5;231m          [0m[38;5;231m_id[0m[38;5;231m:[0m[38;5;231m [0m[38;5;141m0[0m[38;5;231m,[0m
[38;5;238m 470[0m   [38;5;238mâ”‚[0m [38;5;231m          [0m[38;5;231mtimestamp[0m[38;5;231m:[0m[38;5;231m [0m[38;5;141m1[0m[38;5;231m,[0m
[38;5;238m 471[0m   [38;5;238mâ”‚[0m [38;5;231m          [0m[38;5;231mtimestamp_ms[0m[38;5;231m:[0m[38;5;231m [0m[38;5;141m1[0m[38;5;231m,[0m
[38;5;238m 472[0m   [38;5;238mâ”‚[0m [38;5;231m          [0m[38;5;231msender_name[0m[38;5;231m:[0m[38;5;231m [0m[38;5;141m1[0m[38;5;231m,[0m
[38;5;238m 473[0m   [38;5;238mâ”‚[0m [38;5;231m          [0m[38;5;231mcontent[0m[38;5;231m:[0m[38;5;231m [0m[38;5;141m1[0m[38;5;231m,[0m
[38;5;238m 474[0m   [38;5;238mâ”‚[0m [38;5;231m          [0m[38;5;231mphotos[0m[38;5;231m:[0m[38;5;231m [0m[38;5;141m1[0m[38;5;231m,[0m
[38;5;238m 475[0m   [38;5;238mâ”‚[0m [38;5;231m          [0m[38;5;231mis_geoblocked_for_viewer[0m[38;5;231m:[0m[38;5;231m [0m[38;5;141m1[0m[38;5;231m,[0m
[38;5;238m 476[0m   [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m 477[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m 478[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m][0m[38;5;231m;[0m
[38;5;238m 479[0m   [38;5;238mâ”‚[0m 
[38;5;238m 480[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mmessages[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;203mawait[0m[38;5;231m [0m[38;5;231mcollection[0m[38;5;231m.[0m[38;5;231maggregate[0m[38;5;231m([0m[38;5;231mpipeline[0m[38;5;231m)[0m[38;5;231m.[0m[38;5;231mtoArray[0m[38;5;231m()[0m[38;5;231m;[0m
[38;5;238m 481[0m   [38;5;238mâ”‚[0m 
[38;5;238m 482[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;242m//[0m[38;5;242m Try to save the fetched data in Redis with a catch for errors[0m
[38;5;238m 483[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;203mtry[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 484[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;203mawait[0m[38;5;231m [0m[38;5;231mredis[0m[38;5;231m.[0m[38;5;231mset[0m[38;5;231m([0m[38;5;231mcacheKey[0m[38;5;231m, [0m[38;5;149mJSON[0m[38;5;231m.[0m[38;5;231mstringify[0m[38;5;231m([0m[38;5;231mmessages[0m[38;5;231m)[0m[38;5;231m, [0m[38;5;186m"[0m[38;5;186mEX[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;141m36000[0m[38;5;231m)[0m[38;5;231m;[0m[38;5;231m [0m[38;5;242m//[0m[38;5;242m Setting an expiry o[0m
[38;5;238m    [0m   [38;5;238mâ”‚[0m [38;5;242mf 10 hours[0m
[38;5;238m 485[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m}[0m[38;5;231m [0m[38;5;203mcatch[0m[38;5;231m [0m[38;5;231m([0m[38;5;231mredisError[0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 486[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;149mconsole[0m[38;5;231m.[0m[38;5;81merror[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mFailed to save data to Redis:[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;231mredisError[0m[38;5;231m.[0m[38;5;231mmessage[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 487[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;242m//[0m[38;5;242m Again, only log the error; don't throw, to ensure we still return MongoDB data[0m
[38;5;238m 488[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m}[0m
[38;5;238m 489[0m   [38;5;238mâ”‚[0m 
[38;5;238m 490[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231mlogEndpointInfo[0m[38;5;231m([0m[38;5;231mreq[0m[38;5;231m, [0m[38;5;231mres[0m[38;5;231m, [0m[38;5;203m`[0m[38;5;186mG[0m[38;5;186mE[0m[38;5;186mT[0m[38;5;186m [0m[38;5;186m/[0m[38;5;186mm[0m[38;5;186me[0m[38;5;186ms[0m[38;5;186ms[0m[38;5;186ma[0m[38;5;186mg[0m[38;5;186me[0m[38;5;186ms[0m[38;5;186m/[0m[38;5;203m${[0m[38;5;231mreq[0m[38;5;231m.[0m[38;5;231mparams[0m[38;5;231m.[0m[38;5;231mcollectionName[0m[38;5;203m}[0m[38;5;203m`[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 491[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231mres[0m[38;5;231m.[0m[38;5;231mstatus[0m[38;5;231m([0m[38;5;141m200[0m[38;5;231m)[0m[38;5;231m.[0m[38;5;231mjson[0m[38;5;231m([0m[38;5;231mmessages[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 492[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m}[0m[38;5;231m [0m[38;5;203mcatch[0m[38;5;231m [0m[38;5;231m([0m[38;5;231merror[0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 493[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;149mconsole[0m[38;5;231m.[0m[38;5;81merror[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mFailed to fetch messages:[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;231merror[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 494[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231mres[0m[38;5;231m.[0m[38;5;231mstatus[0m[38;5;231m([0m[38;5;141m500[0m[38;5;231m)[0m[38;5;231m.[0m[38;5;231msend[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mInternal Server Error[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 495[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m}[0m
[38;5;238m 496[0m   [38;5;238mâ”‚[0m [38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 497[0m   [38;5;238mâ”‚[0m 
[38;5;238m 498[0m   [38;5;238mâ”‚[0m [38;5;242m//[0m[38;5;242m Endpoint to upload messages[0m
[38;5;238m 499[0m   [38;5;238mâ”‚[0m [38;5;81mconst[0m[38;5;231m [0m[38;5;149mnormalizeAndSanitize[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231m([0m[38;5;208mstr[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 500[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;203mreturn[0m[38;5;231m [0m[38;5;231mstr[0m
[38;5;238m 501[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m.[0m[38;5;231mnormalize[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mNFD[0m[38;5;186m"[0m[38;5;231m)[0m
[38;5;238m 502[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m.[0m[38;5;231mreplace[0m[38;5;231m([0m[38;5;214m/[0m[38;5;141m[[0m[38;5;141m\u0300[0m[38;5;141m-[0m[38;5;141m\u036f[0m[38;5;141m][0m[38;5;214m/[0m[38;5;203mg[0m[38;5;231m, [0m[38;5;186m"[0m[38;5;186m"[0m[38;5;231m)[0m
[38;5;238m 503[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m.[0m[38;5;231mreplace[0m[38;5;231m([0m[38;5;214m/[0m[38;5;141m\s[0m[38;5;203m+[0m[38;5;214m/[0m[38;5;203mg[0m[38;5;231m, [0m[38;5;186m"[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 504[0m   [38;5;238mâ”‚[0m [38;5;231m}[0m[38;5;231m;[0m
[38;5;238m 505[0m   [38;5;238mâ”‚[0m 
[38;5;238m 506[0m   [38;5;238mâ”‚[0m [38;5;231mapp[0m[38;5;231m.[0m[38;5;231mpost[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186m/upload[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;231mupload[0m[38;5;231m.[0m[38;5;231marray[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mfiles[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m, [0m[38;5;81masync[0m[38;5;231m [0m[38;5;231m([0m[38;5;208mreq[0m[38;5;231m,[0m[38;5;231m [0m[38;5;208mres[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 507[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;149mconsole[0m[38;5;231m.[0m[38;5;81mlog[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mRequest body:[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;231mreq[0m[38;5;231m.[0m[38;5;231mbody[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 508[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;149mconsole[0m[38;5;231m.[0m[38;5;81mlog[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mFiles:[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;231mreq[0m[38;5;231m.[0m[38;5;231mfiles[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 509[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mcombinedJson[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;203mawait[0m[38;5;231m [0m[38;5;231mcombine_and_convert_json_files[0m[38;5;231m([0m
[38;5;238m 510[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231mreq[0m[38;5;231m.[0m[38;5;231mfiles[0m[38;5;231m.[0m[38;5;231mmap[0m[38;5;231m([0m[38;5;231m([0m[38;5;208mfile[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231mfile[0m[38;5;231m.[0m[38;5;231mpath[0m[38;5;231m)[0m
[38;5;238m 511[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 512[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231m{[0m[38;5;231m [0m[38;5;231mparticipants[0m[38;5;231m,[0m[38;5;231m [0m[38;5;231mmessages[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mcombinedJson[0m[38;5;231m;[0m
[38;5;238m 513[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mlet[0m[38;5;231m [0m[38;5;231mcollectionName[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mnormalizeAndSanitize[0m[38;5;231m([0m[38;5;231mparticipants[0m[38;5;231m[[0m[38;5;141m0[0m[38;5;231m][0m[38;5;231m.[0m[38;5;231mname[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 514[0m   [38;5;238mâ”‚[0m 
[38;5;238m 515[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mdb[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mclient[0m[38;5;231m.[0m[38;5;231mdb[0m[38;5;231m([0m[38;5;231mMESSAGE_DATABASE[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 516[0m   [38;5;238mâ”‚[0m 
[38;5;238m 517[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mlet[0m[38;5;231m [0m[38;5;231mindex[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;141m0[0m[38;5;231m;[0m
[38;5;238m 518[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mlet[0m[38;5;231m [0m[38;5;231moriginalCollectionName[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mcollectionName[0m[38;5;231m;[0m
[38;5;238m 519[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mlet[0m[38;5;231m [0m[38;5;231mcollections[0m[38;5;231m;[0m
[38;5;238m 520[0m   [38;5;238mâ”‚[0m 
[38;5;238m 521[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;203mdo[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 522[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231mcollections[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;203mawait[0m[38;5;231m [0m[38;5;231mdb[0m[38;5;231m.[0m[38;5;231mlistCollections[0m[38;5;231m([0m[38;5;231m{[0m[38;5;231m [0m[38;5;231mname[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231mcollectionName[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m)[0m[38;5;231m.[0m[38;5;231mtoArray[0m[38;5;231m()[0m[38;5;231m;[0m
[38;5;238m 523[0m   [38;5;238mâ”‚[0m 
[38;5;238m 524[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;203mif[0m[38;5;231m [0m[38;5;231m([0m[38;5;231mcollections[0m[38;5;231m.[0m[38;5;231mlength[0m[38;5;231m [0m[38;5;203m>[0m[38;5;231m [0m[38;5;141m0[0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 525[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231mindex[0m[38;5;203m++[0m[38;5;231m;[0m
[38;5;238m 526[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231mcollectionName[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;203m`[0m[38;5;203m${[0m[38;5;231moriginalCollectionName[0m[38;5;203m}[0m[38;5;186m_[0m[38;5;203m${[0m[38;5;231mindex[0m[38;5;203m}[0m[38;5;203m`[0m[38;5;231m;[0m
[38;5;238m 527[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m}[0m
[38;5;238m 528[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m}[0m[38;5;231m [0m[38;5;203mwhile[0m[38;5;231m [0m[38;5;231m([0m[38;5;231mcollections[0m[38;5;231m.[0m[38;5;231mlength[0m[38;5;231m [0m[38;5;203m>[0m[38;5;231m [0m[38;5;141m0[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 529[0m   [38;5;238mâ”‚[0m 
[38;5;238m 530[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mcollection[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mdb[0m[38;5;231m.[0m[38;5;231mcollection[0m[38;5;231m([0m[38;5;231mcollectionName[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 531[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;203mawait[0m[38;5;231m [0m[38;5;231mcollection[0m[38;5;231m.[0m[38;5;231minsertMany[0m[38;5;231m([0m[38;5;231mmessages[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 532[0m   [38;5;238mâ”‚[0m 
[38;5;238m 533[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231mlogEndpointInfo[0m[38;5;231m([0m[38;5;231mreq[0m[38;5;231m, [0m[38;5;231mres[0m[38;5;231m, [0m[38;5;186m"[0m[38;5;186mPOST /upload[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 534[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231mres[0m[38;5;231m.[0m[38;5;231mstatus[0m[38;5;231m([0m[38;5;141m200[0m[38;5;231m)[0m[38;5;231m.[0m[38;5;231mjson[0m[38;5;231m([0m[38;5;231m{[0m
[38;5;238m 535[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231mmessage[0m[38;5;231m:[0m[38;5;231m [0m[38;5;203m`[0m[38;5;186mM[0m[38;5;186me[0m[38;5;186ms[0m[38;5;186ms[0m[38;5;186ma[0m[38;5;186mg[0m[38;5;186me[0m[38;5;186ms[0m[38;5;186m [0m[38;5;186mu[0m[38;5;186mp[0m[38;5;186ml[0m[38;5;186mo[0m[38;5;186ma[0m[38;5;186md[0m[38;5;186me[0m[38;5;186md[0m[38;5;186m [0m[38;5;186mt[0m[38;5;186mo[0m[38;5;186m [0m[38;5;186mc[0m[38;5;186mo[0m[38;5;186ml[0m[38;5;186ml[0m[38;5;186me[0m[38;5;186mc[0m[38;5;186mt[0m[38;5;186mi[0m[38;5;186mo[0m[38;5;186mn[0m[38;5;186m:[0m[38;5;186m [0m[38;5;203m${[0m[38;5;231mcollectionName[0m[38;5;203m}[0m[38;5;203m`[0m[38;5;231m,[0m
[38;5;238m 536[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231mcollectionName[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231mcollectionName[0m[38;5;231m,[0m
[38;5;238m 537[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231mmessageCount[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231mmessages[0m[38;5;231m.[0m[38;5;231mlength[0m[38;5;231m,[0m
[38;5;238m 538[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 539[0m   [38;5;238mâ”‚[0m [38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 540[0m   [38;5;238mâ”‚[0m 
[38;5;238m 541[0m   [38;5;238mâ”‚[0m [38;5;242m//[0m[38;5;242m Endpoint to delete a collection[0m
[38;5;238m 542[0m   [38;5;238mâ”‚[0m [38;5;231mapp[0m[38;5;231m.[0m[38;5;231mdelete[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186m/delete/:collectionName[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;81masync[0m[38;5;231m [0m[38;5;231m([0m[38;5;208mreq[0m[38;5;231m,[0m[38;5;231m [0m[38;5;208mres[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 543[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mcollectionName[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;81mdecodeURIComponent[0m[38;5;231m([0m[38;5;231mreq[0m[38;5;231m.[0m[38;5;231mparams[0m[38;5;231m.[0m[38;5;231mcollectionName[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 544[0m   [38;5;238mâ”‚[0m 
[38;5;238m 545[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mdb[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mclient[0m[38;5;231m.[0m[38;5;231mdb[0m[38;5;231m([0m[38;5;231mMESSAGE_DATABASE[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 546[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mcollection[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mdb[0m[38;5;231m.[0m[38;5;231mcollection[0m[38;5;231m([0m[38;5;231mcollectionName[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 547[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;203mawait[0m[38;5;231m [0m[38;5;231mcollection[0m[38;5;231m.[0m[38;5;231mdrop[0m[38;5;231m()[0m[38;5;231m;[0m
[38;5;238m 548[0m   [38;5;238mâ”‚[0m 
[38;5;238m 549[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231mlogEndpointInfo[0m[38;5;231m([0m[38;5;231mreq[0m[38;5;231m, [0m[38;5;231mres[0m[38;5;231m, [0m[38;5;203m`[0m[38;5;186mD[0m[38;5;186mE[0m[38;5;186mL[0m[38;5;186mE[0m[38;5;186mT[0m[38;5;186mE[0m[38;5;186m [0m[38;5;186m/[0m[38;5;186md[0m[38;5;186me[0m[38;5;186ml[0m[38;5;186me[0m[38;5;186mt[0m[38;5;186me[0m[38;5;186m/[0m[38;5;203m${[0m[38;5;231mreq[0m[38;5;231m.[0m[38;5;231mparams[0m[38;5;231m.[0m[38;5;231mcollectionName[0m[38;5;203m}[0m[38;5;203m`[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 550[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231mres[0m[38;5;231m.[0m[38;5;231mstatus[0m[38;5;231m([0m[38;5;141m200[0m[38;5;231m)[0m[38;5;231m.[0m[38;5;231mjson[0m[38;5;231m([0m[38;5;231m{[0m
[38;5;238m 551[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231mmessage[0m[38;5;231m:[0m[38;5;231m [0m[38;5;203m`[0m[38;5;186mC[0m[38;5;186mo[0m[38;5;186ml[0m[38;5;186ml[0m[38;5;186me[0m[38;5;186mc[0m[38;5;186mt[0m[38;5;186mi[0m[38;5;186mo[0m[38;5;186mn[0m[38;5;186m [0m[38;5;186m"[0m[38;5;203m${[0m[38;5;231mcollectionName[0m[38;5;203m}[0m[38;5;186m"[0m[38;5;186m [0m[38;5;186md[0m[38;5;186me[0m[38;5;186ml[0m[38;5;186me[0m[38;5;186mt[0m[38;5;186me[0m[38;5;186md[0m[38;5;186m.[0m[38;5;203m`[0m[38;5;231m,[0m
[38;5;238m 552[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231mcollectionName[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231mcollectionName[0m[38;5;231m,[0m
[38;5;238m 553[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 554[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;242m//[0m[38;5;242m After dropping the collection[0m
[38;5;238m 555[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mcachedCollections[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mcache[0m[38;5;231m.[0m[38;5;231mget[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mcollections[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m [0m[38;5;203m||[0m[38;5;231m [0m[38;5;231m[[0m[38;5;231m][0m[38;5;231m;[0m
[38;5;238m 556[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mupdatedCollections[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mcachedCollections[0m[38;5;231m.[0m[38;5;231mfilter[0m[38;5;231m([0m
[38;5;238m 557[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m([0m[38;5;208mcol[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231mcol[0m[38;5;231m.[0m[38;5;231mname[0m[38;5;231m [0m[38;5;203m!==[0m[38;5;231m [0m[38;5;231mcollectionName[0m
[38;5;238m 558[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 559[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231mcache[0m[38;5;231m.[0m[38;5;231mset[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mcollections[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;231mupdatedCollections[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 560[0m   [38;5;238mâ”‚[0m [38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 561[0m   [38;5;238mâ”‚[0m 
[38;5;238m 562[0m   [38;5;238mâ”‚[0m [38;5;242m//[0m[38;5;242m Endpoint to check if a photo is available for a collection[0m
[38;5;238m 563[0m   [38;5;238mâ”‚[0m [38;5;231mapp[0m[38;5;231m.[0m[38;5;231mget[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186m/messages/:collectionName/photo[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;81masync[0m[38;5;231m [0m[38;5;231m([0m[38;5;208mreq[0m[38;5;231m,[0m[38;5;231m [0m[38;5;208mres[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 564[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mcollectionName[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;81mdecodeURIComponent[0m[38;5;231m([0m[38;5;231mreq[0m[38;5;231m.[0m[38;5;231mparams[0m[38;5;231m.[0m[38;5;231mcollectionName[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 565[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231msanitizedCollectionName[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231msanitizeName[0m[38;5;231m([0m[38;5;231mcollectionName[0m[38;5;231m)[0m[38;5;231m;[0m[38;5;231m [0m[38;5;242m//[0m[38;5;242m Sanitize the collection nam[0m
[38;5;238m    [0m   [38;5;238mâ”‚[0m [38;5;242me[0m
[38;5;238m 566[0m   [38;5;238mâ”‚[0m 
[38;5;238m 567[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mdb[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mclient[0m[38;5;231m.[0m[38;5;231mdb[0m[38;5;231m([0m[38;5;231mMESSAGE_DATABASE[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 568[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mcollection[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mdb[0m[38;5;231m.[0m[38;5;231mcollection[0m[38;5;231m([0m[38;5;231msanitizedCollectionName[0m[38;5;231m)[0m[38;5;231m;[0m[38;5;231m [0m[38;5;242m//[0m[38;5;242m Use sanitized name for MongoDB[0m
[38;5;238m    [0m   [38;5;238mâ”‚[0m [38;5;242m collection[0m
[38;5;238m 569[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mresult[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;203mawait[0m[38;5;231m [0m[38;5;231mcollection[0m[38;5;231m.[0m[38;5;231mfindOne[0m[38;5;231m([0m[38;5;231m{[0m[38;5;231m [0m[38;5;231mphoto[0m[38;5;231m:[0m[38;5;231m [0m[38;5;141mtrue[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 570[0m   [38;5;238mâ”‚[0m 
[38;5;238m 571[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;203mif[0m[38;5;231m [0m[38;5;231m([0m[38;5;203m![0m[38;5;231mresult[0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 572[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;242m//[0m[38;5;242m logEndpointInfo(req, res, `GET /messages/${req.params.collectionName}/photo`);[0m
[38;5;238m 573[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231mres[0m[38;5;231m.[0m[38;5;231mstatus[0m[38;5;231m([0m[38;5;141m200[0m[38;5;231m)[0m[38;5;231m.[0m[38;5;231mjson[0m[38;5;231m([0m[38;5;231m{[0m[38;5;231m [0m[38;5;231misPhotoAvailable[0m[38;5;231m:[0m[38;5;231m [0m[38;5;141mfalse[0m[38;5;231m,[0m[38;5;231m [0m[38;5;231mphotoUrl[0m[38;5;231m:[0m[38;5;231m [0m[38;5;141mnull[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 574[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;149mconsole[0m[38;5;231m.[0m[38;5;81mlog[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mPhoto not found[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 575[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;203mreturn[0m[38;5;231m;[0m
[38;5;238m 576[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m}[0m
[38;5;238m 577[0m   [38;5;238mâ”‚[0m 
[38;5;238m 578[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;242m//[0m[38;5;242m Use sanitized name for photo URL[0m
[38;5;238m 579[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mphotoUrl[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;203m`[0m[38;5;186mh[0m[38;5;186mt[0m[38;5;186mt[0m[38;5;186mp[0m[38;5;186ms[0m[38;5;186m:[0m[38;5;186m/[0m[38;5;186m/[0m[38;5;203m${[0m[38;5;231mreq[0m[38;5;231m.[0m[38;5;231mget[0m[38;5;231m([0m
[38;5;238m 580[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;186m"[0m[38;5;186mhost[0m[38;5;186m"[0m
[38;5;238m 581[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m)[0m[38;5;203m}[0m[38;5;186m/[0m[38;5;186ms[0m[38;5;186me[0m[38;5;186mr[0m[38;5;186mv[0m[38;5;186me[0m[38;5;186m/[0m[38;5;186mp[0m[38;5;186mh[0m[38;5;186mo[0m[38;5;186mt[0m[38;5;186mo[0m[38;5;186m/[0m[38;5;203m${[0m[38;5;231msanitizedCollectionName[0m[38;5;203m}[0m[38;5;203m`[0m[38;5;231m;[0m
[38;5;238m 582[0m   [38;5;238mâ”‚[0m 
[38;5;238m 583[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;242m//[0m[38;5;242m logEndpointInfo(req, res, `GET /messages/${req.params.collectionName}/photo`);[0m
[38;5;238m 584[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231mres[0m[38;5;231m.[0m[38;5;231mstatus[0m[38;5;231m([0m[38;5;141m200[0m[38;5;231m)[0m[38;5;231m.[0m[38;5;231mjson[0m[38;5;231m([0m[38;5;231m{[0m[38;5;231m [0m[38;5;231misPhotoAvailable[0m[38;5;231m:[0m[38;5;231m [0m[38;5;141mtrue[0m[38;5;231m,[0m[38;5;231m [0m[38;5;231mphotoUrl[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231mphotoUrl[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 585[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;149mconsole[0m[38;5;231m.[0m[38;5;81mlog[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mPhoto found[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 586[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;149mconsole[0m[38;5;231m.[0m[38;5;81mlog[0m[38;5;231m([0m[38;5;231mphotoUrl[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 587[0m   [38;5;238mâ”‚[0m [38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 588[0m   [38;5;238mâ”‚[0m 
[38;5;238m 589[0m   [38;5;238mâ”‚[0m [38;5;242m//[0m[38;5;242m Endpoint to upload a photo for a collection[0m
[38;5;238m 590[0m   [38;5;238mâ”‚[0m [38;5;231mapp[0m[38;5;231m.[0m[38;5;231mpost[0m[38;5;231m([0m
[38;5;238m 591[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;186m"[0m[38;5;186m/upload/photo/:collectionName[0m[38;5;186m"[0m[38;5;231m,[0m
[38;5;238m 592[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231mupload_photo[0m[38;5;231m.[0m[38;5;231msingle[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mphoto[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m,[0m
[38;5;238m 593[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81masync[0m[38;5;231m [0m[38;5;231m([0m[38;5;208mreq[0m[38;5;231m,[0m[38;5;231m [0m[38;5;208mres[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 594[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;203mif[0m[38;5;231m [0m[38;5;231m([0m[38;5;203m![0m[38;5;231mreq[0m[38;5;231m.[0m[38;5;231mfile[0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 595[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;242m//[0m[38;5;242m logEndpointInfo(req, res, `POST /upload/photo/${req.params.collectionName}`);[0m
[38;5;238m 596[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231mres[0m[38;5;231m.[0m[38;5;231mstatus[0m[38;5;231m([0m[38;5;141m400[0m[38;5;231m)[0m[38;5;231m.[0m[38;5;231mjson[0m[38;5;231m([0m[38;5;231m{[0m[38;5;231m [0m[38;5;231mmessage[0m[38;5;231m:[0m[38;5;231m [0m[38;5;186m"[0m[38;5;186mNo photo provided[0m[38;5;186m"[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 597[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;203mreturn[0m[38;5;231m;[0m
[38;5;238m 598[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m}[0m
[38;5;238m 599[0m   [38;5;238mâ”‚[0m 
[38;5;238m 600[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231msanitizedCollectionName[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231msanitizeName[0m[38;5;231m([0m
[38;5;238m 601[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;81mdecodeURIComponent[0m[38;5;231m([0m[38;5;231mreq[0m[38;5;231m.[0m[38;5;231mparams[0m[38;5;231m.[0m[38;5;231mcollectionName[0m[38;5;231m)[0m
[38;5;238m 602[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 603[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mdb[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mclient[0m[38;5;231m.[0m[38;5;231mdb[0m[38;5;231m([0m[38;5;231mMESSAGE_DATABASE[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 604[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mcollection[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mdb[0m[38;5;231m.[0m[38;5;231mcollection[0m[38;5;231m([0m[38;5;231msanitizedCollectionName[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 605[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;203mawait[0m[38;5;231m [0m[38;5;231mcollection[0m[38;5;231m.[0m[38;5;231mupdateOne[0m[38;5;231m([0m[38;5;231m{[0m[38;5;231m}[0m[38;5;231m, [0m[38;5;231m{[0m[38;5;231m [0m[38;5;231m$set[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231m{[0m[38;5;231m [0m[38;5;231mphoto[0m[38;5;231m:[0m[38;5;231m [0m[38;5;141mtrue[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m, [0m[38;5;231m{[0m[38;5;231m [0m[38;5;231mupsert[0m[38;5;231m:[0m[38;5;231m [0m[38;5;141mtrue[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 606[0m   [38;5;238mâ”‚[0m 
[38;5;238m 607[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;242m//[0m[38;5;242m logEndpointInfo(req, res, `POST /upload/photo/${req.params.collectionName}`);[0m
[38;5;238m 608[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231mres[0m[38;5;231m.[0m[38;5;231mstatus[0m[38;5;231m([0m[38;5;141m200[0m[38;5;231m)[0m[38;5;231m.[0m[38;5;231mjson[0m[38;5;231m([0m[38;5;231m{[0m[38;5;231m [0m[38;5;231mmessage[0m[38;5;231m:[0m[38;5;231m [0m[38;5;186m"[0m[38;5;186mPhoto uploaded successfully[0m[38;5;186m"[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 609[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m}[0m
[38;5;238m 610[0m   [38;5;238mâ”‚[0m [38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 611[0m   [38;5;238mâ”‚[0m 
[38;5;238m 612[0m   [38;5;238mâ”‚[0m [38;5;242m//[0m[38;5;242m Endpoint to serve a photo for a collection[0m
[38;5;238m 613[0m   [38;5;238mâ”‚[0m [38;5;231mapp[0m[38;5;231m.[0m[38;5;231mget[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186m/serve/photo/:collectionName[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;81masync[0m[38;5;231m [0m[38;5;231m([0m[38;5;208mreq[0m[38;5;231m,[0m[38;5;231m [0m[38;5;208mres[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 614[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231msanitizedCollectionName[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231msanitizeName[0m[38;5;231m([0m
[38;5;238m 615[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mdecodeURIComponent[0m[38;5;231m([0m[38;5;231mreq[0m[38;5;231m.[0m[38;5;231mparams[0m[38;5;231m.[0m[38;5;231mcollectionName[0m[38;5;231m)[0m
[38;5;238m 616[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 617[0m   [38;5;238mâ”‚[0m 
[38;5;238m 618[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mphotoDir[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mpath[0m[38;5;231m.[0m[38;5;231mjoin[0m[38;5;231m([0m[38;5;149m__dirname[0m[38;5;231m, [0m[38;5;186m"[0m[38;5;186mphotos[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 619[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mfiles[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;203mawait[0m[38;5;231m [0m[38;5;231mfs[0m[38;5;231m.[0m[38;5;231mreaddir[0m[38;5;231m([0m[38;5;231mphotoDir[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 620[0m   [38;5;238mâ”‚[0m 
[38;5;238m 621[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mphotoFile[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mfiles[0m[38;5;231m.[0m[38;5;231mfind[0m[38;5;231m([0m[38;5;231m([0m[38;5;208mfile[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m
[38;5;238m 622[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231mfile[0m[38;5;231m.[0m[38;5;231mstartsWith[0m[38;5;231m([0m[38;5;231msanitizedCollectionName[0m[38;5;231m)[0m
[38;5;238m 623[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 624[0m   [38;5;238mâ”‚[0m 
[38;5;238m 625[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;203mif[0m[38;5;231m [0m[38;5;231m([0m[38;5;203m![0m[38;5;231mphotoFile[0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 626[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;242m//[0m[38;5;242m logEndpointInfo(req, res, `GET /serve/photo/${req.params.collectionName}`);[0m
[38;5;238m 627[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231mres[0m[38;5;231m.[0m[38;5;231mstatus[0m[38;5;231m([0m[38;5;141m404[0m[38;5;231m)[0m[38;5;231m.[0m[38;5;231mjson[0m[38;5;231m([0m[38;5;231m{[0m[38;5;231m [0m[38;5;231mmessage[0m[38;5;231m:[0m[38;5;231m [0m[38;5;186m"[0m[38;5;186mPhoto not found[0m[38;5;186m"[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 628[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;149mconsole[0m[38;5;231m.[0m[38;5;81mlog[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mPhoto not found[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 629[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;203mreturn[0m[38;5;231m;[0m
[38;5;238m 630[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m}[0m
[38;5;238m 631[0m   [38;5;238mâ”‚[0m 
[38;5;238m 632[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mphotoPath[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mpath[0m[38;5;231m.[0m[38;5;231mjoin[0m[38;5;231m([0m[38;5;231mphotoDir[0m[38;5;231m, [0m[38;5;231mphotoFile[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 633[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;242m//[0m[38;5;242m logEndpointInfo(req, res, `GET /serve/photo/${req.params.collectionName}`);[0m
[38;5;238m 634[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231mres[0m[38;5;231m.[0m[38;5;231msendFile[0m[38;5;231m([0m[38;5;231mphotoPath[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 635[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;149mconsole[0m[38;5;231m.[0m[38;5;81mlog[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mPhoto found[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 636[0m   [38;5;238mâ”‚[0m [38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 637[0m   [38;5;238mâ”‚[0m 
[38;5;238m 638[0m   [38;5;238mâ”‚[0m [38;5;242m//[0m[38;5;242m Endpoint to delete a photo for a collection[0m
[38;5;238m 639[0m   [38;5;238mâ”‚[0m [38;5;231mapp[0m[38;5;231m.[0m[38;5;231mdelete[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186m/delete/photo/:collectionName[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;81masync[0m[38;5;231m [0m[38;5;231m([0m[38;5;208mreq[0m[38;5;231m,[0m[38;5;231m [0m[38;5;208mres[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 640[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231msanitizedCollectionName[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231msanitizeName[0m[38;5;231m([0m
[38;5;238m 641[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mdecodeURIComponent[0m[38;5;231m([0m[38;5;231mreq[0m[38;5;231m.[0m[38;5;231mparams[0m[38;5;231m.[0m[38;5;231mcollectionName[0m[38;5;231m)[0m
[38;5;238m 642[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 643[0m   [38;5;238mâ”‚[0m 
[38;5;238m 644[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mphotoDir[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mpath[0m[38;5;231m.[0m[38;5;231mjoin[0m[38;5;231m([0m[38;5;149m__dirname[0m[38;5;231m, [0m[38;5;186m"[0m[38;5;186mphotos[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 645[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mfiles[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;203mawait[0m[38;5;231m [0m[38;5;231mfs[0m[38;5;231m.[0m[38;5;231mreaddir[0m[38;5;231m([0m[38;5;231mphotoDir[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 646[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mdb[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mclient[0m[38;5;231m.[0m[38;5;231mdb[0m[38;5;231m([0m[38;5;231mMESSAGE_DATABASE[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 647[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mcollection[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mdb[0m[38;5;231m.[0m[38;5;231mcollection[0m[38;5;231m([0m[38;5;231msanitizedCollectionName[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 648[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mphotoFile[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mfiles[0m[38;5;231m.[0m[38;5;231mfind[0m[38;5;231m([0m[38;5;231m([0m[38;5;208mfile[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m
[38;5;238m 649[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231mfile[0m[38;5;231m.[0m[38;5;231mstartsWith[0m[38;5;231m([0m[38;5;231msanitizedCollectionName[0m[38;5;231m)[0m
[38;5;238m 650[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 651[0m   [38;5;238mâ”‚[0m 
[38;5;238m 652[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;203mif[0m[38;5;231m [0m[38;5;231m([0m[38;5;231mphotoFile[0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 653[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mphotoPath[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mpath[0m[38;5;231m.[0m[38;5;231mjoin[0m[38;5;231m([0m[38;5;231mphotoDir[0m[38;5;231m, [0m[38;5;231mphotoFile[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 654[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;203mawait[0m[38;5;231m [0m[38;5;231mfs[0m[38;5;231m.[0m[38;5;231munlink[0m[38;5;231m([0m[38;5;231mphotoPath[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 655[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;203mawait[0m[38;5;231m [0m[38;5;231mcollection[0m[38;5;231m.[0m[38;5;231mupdateOne[0m[38;5;231m([0m
[38;5;238m 656[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m{[0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m 657[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m{[0m[38;5;231m [0m[38;5;231m$set[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231m{[0m[38;5;231m [0m[38;5;231mphoto[0m[38;5;231m:[0m[38;5;231m [0m[38;5;141mfalse[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m 658[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m{[0m[38;5;231m [0m[38;5;231mupsert[0m[38;5;231m:[0m[38;5;231m [0m[38;5;141mtrue[0m[38;5;231m [0m[38;5;231m}[0m
[38;5;238m 659[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 660[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231mres[0m
[38;5;238m 661[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m.[0m[38;5;231mstatus[0m[38;5;231m([0m[38;5;141m200[0m[38;5;231m)[0m
[38;5;238m 662[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m.[0m[38;5;231mjson[0m[38;5;231m([0m[38;5;231m{[0m[38;5;231m [0m[38;5;231mmessage[0m[38;5;231m:[0m[38;5;231m [0m[38;5;186m"[0m[38;5;186mPhoto deleted successfully and database updated[0m[38;5;186m"[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 663[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;203mreturn[0m[38;5;231m;[0m
[38;5;238m 664[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m}[0m[38;5;231m [0m[38;5;203melse[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 665[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mdoc[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;203mawait[0m[38;5;231m [0m[38;5;231mcollection[0m[38;5;231m.[0m[38;5;231mfindOne[0m[38;5;231m([0m[38;5;231m{[0m[38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 666[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;203mif[0m[38;5;231m [0m[38;5;231m([0m[38;5;231mdoc[0m[38;5;231m [0m[38;5;203m&&[0m[38;5;231m [0m[38;5;231mdoc[0m[38;5;231m.[0m[38;5;231mphoto[0m[38;5;231m [0m[38;5;203m===[0m[38;5;231m [0m[38;5;141mtrue[0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 667[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;203mawait[0m[38;5;231m [0m[38;5;231mcollection[0m[38;5;231m.[0m[38;5;231mupdateOne[0m[38;5;231m([0m
[38;5;238m 668[0m   [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;231m{[0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m 669[0m   [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;231m{[0m[38;5;231m [0m[38;5;231m$set[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231m{[0m[38;5;231m [0m[38;5;231mphoto[0m[38;5;231m:[0m[38;5;231m [0m[38;5;141mfalse[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m 670[0m   [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;231m{[0m[38;5;231m [0m[38;5;231mupsert[0m[38;5;231m:[0m[38;5;231m [0m[38;5;141mtrue[0m[38;5;231m [0m[38;5;231m}[0m
[38;5;238m 671[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 672[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231mres[0m
[38;5;238m 673[0m   [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;231m.[0m[38;5;231mstatus[0m[38;5;231m([0m[38;5;141m200[0m[38;5;231m)[0m
[38;5;238m 674[0m   [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;231m.[0m[38;5;231mjson[0m[38;5;231m([0m[38;5;231m{[0m[38;5;231m [0m[38;5;231mmessage[0m[38;5;231m:[0m[38;5;231m [0m[38;5;186m"[0m[38;5;186mPhoto not found, but database updated[0m[38;5;186m"[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 675[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;203mreturn[0m[38;5;231m;[0m
[38;5;238m 676[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m}[0m
[38;5;238m 677[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231mres[0m
[38;5;238m 678[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m.[0m[38;5;231mstatus[0m[38;5;231m([0m[38;5;141m404[0m[38;5;231m)[0m
[38;5;238m 679[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m.[0m[38;5;231mjson[0m[38;5;231m([0m[38;5;231m{[0m[38;5;231m [0m[38;5;231mmessage[0m[38;5;231m:[0m[38;5;231m [0m[38;5;186m"[0m[38;5;186mPhoto not found and nothing to update in database[0m[38;5;186m"[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 680[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m}[0m
[38;5;238m 681[0m   [38;5;238mâ”‚[0m [38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 682[0m   [38;5;238mâ”‚[0m 
[38;5;238m 683[0m   [38;5;238mâ”‚[0m [38;5;242m//[0m[38;5;242m Serving static photos[0m
[38;5;238m 684[0m   [38;5;238mâ”‚[0m [38;5;231mapp[0m[38;5;231m.[0m[38;5;231muse[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186m/photos[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;231mexpress[0m[38;5;231m.[0m[38;5;231mstatic[0m[38;5;231m([0m[38;5;231mpath[0m[38;5;231m.[0m[38;5;231mjoin[0m[38;5;231m([0m[38;5;149m__dirname[0m[38;5;231m, [0m[38;5;186m"[0m[38;5;186mphotos[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m)[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 685[0m   [38;5;238mâ”‚[0m [38;5;231mapp[0m[38;5;231m.[0m[38;5;231muse[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186m/inbox[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;231mexpress[0m[38;5;231m.[0m[38;5;231mstatic[0m[38;5;231m([0m[38;5;231mpath[0m[38;5;231m.[0m[38;5;231mjoin[0m[38;5;231m([0m[38;5;149m__dirname[0m[38;5;231m, [0m[38;5;186m"[0m[38;5;186minbox[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m)[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 686[0m   [38;5;238mâ”‚[0m [38;5;242m//[0m[38;5;242m Endpoint to rename a collection[0m
[38;5;238m 687[0m   [38;5;238mâ”‚[0m [38;5;231mapp[0m[38;5;231m.[0m[38;5;231mput[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186m/rename/:currentCollectionName[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;81masync[0m[38;5;231m [0m[38;5;231m([0m[38;5;208mreq[0m[38;5;231m,[0m[38;5;231m [0m[38;5;208mres[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 688[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mcurrentCollectionName[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;81mdecodeURIComponent[0m[38;5;231m([0m
[38;5;238m 689[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231mreq[0m[38;5;231m.[0m[38;5;231mparams[0m[38;5;231m.[0m[38;5;231mcurrentCollectionName[0m
[38;5;238m 690[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 691[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mnewCollectionName[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mreq[0m[38;5;231m.[0m[38;5;231mbody[0m[38;5;231m.[0m[38;5;231mnewCollectionName[0m[38;5;231m.[0m[38;5;231mtrim[0m[38;5;231m()[0m[38;5;231m;[0m
[38;5;238m 692[0m   [38;5;238mâ”‚[0m 
[38;5;238m 693[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;203mif[0m[38;5;231m [0m[38;5;231m([0m[38;5;203m![0m[38;5;231mnewCollectionName[0m[38;5;231m [0m[38;5;203m||[0m[38;5;231m [0m[38;5;203m![0m[38;5;214m/[0m[38;5;203m^[0m[38;5;141m[[0m[38;5;141ma[0m[38;5;141m-[0m[38;5;141mz[0m[38;5;141mA[0m[38;5;141m-[0m[38;5;141mZ[0m[38;5;141m0[0m[38;5;141m-[0m[38;5;141m9[0m[38;5;141m_[0m[38;5;141m][0m[38;5;203m+[0m[38;5;203m$[0m[38;5;214m/[0m[38;5;231m.[0m[38;5;231mtest[0m[38;5;231m([0m[38;5;231mnewCollectionName[0m[38;5;231m)[0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 694[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231mlogEndpointInfo[0m[38;5;231m([0m
[38;5;238m 695[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231mreq[0m[38;5;231m,[0m
[38;5;238m 696[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231mres[0m[38;5;231m,[0m
[38;5;238m 697[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;203m`[0m[38;5;186mP[0m[38;5;186mU[0m[38;5;186mT[0m[38;5;186m [0m[38;5;186m/[0m[38;5;186mr[0m[38;5;186me[0m[38;5;186mn[0m[38;5;186ma[0m[38;5;186mm[0m[38;5;186me[0m[38;5;186m/[0m[38;5;203m${[0m[38;5;231mreq[0m[38;5;231m.[0m[38;5;231mparams[0m[38;5;231m.[0m[38;5;231mcurrentCollectionName[0m[38;5;203m}[0m[38;5;203m`[0m
[38;5;238m 698[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 699[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231mres[0m[38;5;231m.[0m[38;5;231mstatus[0m[38;5;231m([0m[38;5;141m400[0m[38;5;231m)[0m[38;5;231m.[0m[38;5;231mjson[0m[38;5;231m([0m[38;5;231m{[0m
[38;5;238m 700[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231mmessage[0m[38;5;231m:[0m[38;5;231m [0m[38;5;186m"[0m[38;5;186mInvalid collection name: Does not match naming convention[0m[38;5;186m"[0m[38;5;231m,[0m
[38;5;238m 701[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 702[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;203mreturn[0m[38;5;231m;[0m
[38;5;238m 703[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m}[0m
[38;5;238m 704[0m   [38;5;238mâ”‚[0m 
[38;5;238m 705[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mdb[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mclient[0m[38;5;231m.[0m[38;5;231mdb[0m[38;5;231m([0m[38;5;231mMESSAGE_DATABASE[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 706[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mcurrentCollection[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mdb[0m[38;5;231m.[0m[38;5;231mcollection[0m[38;5;231m([0m[38;5;231mcurrentCollectionName[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 707[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;203mawait[0m[38;5;231m [0m[38;5;231mcurrentCollection[0m[38;5;231m.[0m[38;5;231mrename[0m[38;5;231m([0m[38;5;231mnewCollectionName[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 708[0m   [38;5;238mâ”‚[0m 
[38;5;238m 709[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231mlogEndpointInfo[0m[38;5;231m([0m[38;5;231mreq[0m[38;5;231m, [0m[38;5;231mres[0m[38;5;231m, [0m[38;5;203m`[0m[38;5;186mP[0m[38;5;186mU[0m[38;5;186mT[0m[38;5;186m [0m[38;5;186m/[0m[38;5;186mr[0m[38;5;186me[0m[38;5;186mn[0m[38;5;186ma[0m[38;5;186mm[0m[38;5;186me[0m[38;5;186m/[0m[38;5;203m${[0m[38;5;231mreq[0m[38;5;231m.[0m[38;5;231mparams[0m[38;5;231m.[0m[38;5;231mcurrentCollectionName[0m[38;5;203m}[0m[38;5;203m`[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 710[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231mres[0m
[38;5;238m 711[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m.[0m[38;5;231mstatus[0m[38;5;231m([0m[38;5;141m200[0m[38;5;231m)[0m
[38;5;238m 712[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m.[0m[38;5;231mjson[0m[38;5;231m([0m[38;5;231m{[0m[38;5;231m [0m[38;5;231mmessage[0m[38;5;231m:[0m[38;5;231m [0m[38;5;203m`[0m[38;5;186mC[0m[38;5;186mo[0m[38;5;186ml[0m[38;5;186ml[0m[38;5;186me[0m[38;5;186mc[0m[38;5;186mt[0m[38;5;186mi[0m[38;5;186mo[0m[38;5;186mn[0m[38;5;186m [0m[38;5;186mr[0m[38;5;186me[0m[38;5;186mn[0m[38;5;186ma[0m[38;5;186mm[0m[38;5;186me[0m[38;5;186md[0m[38;5;186m [0m[38;5;186mt[0m[38;5;186mo[0m[38;5;186m [0m[38;5;203m${[0m[38;5;231mnewCollectionName[0m[38;5;203m}[0m[38;5;203m`[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 713[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;242m//[0m[38;5;242m After renaming the collection[0m
[38;5;238m 714[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mcount[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;203mawait[0m[38;5;231m [0m[38;5;231mdb[0m[38;5;231m.[0m[38;5;231mcollection[0m[38;5;231m([0m[38;5;231mnewCollectionName[0m[38;5;231m)[0m[38;5;231m.[0m[38;5;231mcountDocuments[0m[38;5;231m()[0m[38;5;231m;[0m
[38;5;238m 715[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mcachedCollections[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mcache[0m[38;5;231m.[0m[38;5;231mget[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mcollections[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m [0m[38;5;203m||[0m[38;5;231m [0m[38;5;231m[[0m[38;5;231m][0m[38;5;231m;[0m
[38;5;238m 716[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mupdatedCollections[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mcachedCollections[0m[38;5;231m.[0m[38;5;231mfilter[0m[38;5;231m([0m
[38;5;238m 717[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m([0m[38;5;208mcol[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231mcol[0m[38;5;231m.[0m[38;5;231mname[0m[38;5;231m [0m[38;5;203m!==[0m[38;5;231m [0m[38;5;231mcurrentCollectionName[0m
[38;5;238m 718[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 719[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231mupdatedCollections[0m[38;5;231m.[0m[38;5;231mpush[0m[38;5;231m([0m[38;5;231m{[0m
[38;5;238m 720[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231mname[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231mnewCollectionName[0m[38;5;231m,[0m
[38;5;238m 721[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231mmessageCount[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231mcount[0m[38;5;231m,[0m
[38;5;238m 722[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 723[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231mcache[0m[38;5;231m.[0m[38;5;231mset[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mcollections[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;231mupdatedCollections[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 724[0m   [38;5;238mâ”‚[0m [38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 725[0m   [38;5;238mâ”‚[0m 
[38;5;238m 726[0m   [38;5;238mâ”‚[0m [38;5;231mapp[0m[38;5;231m.[0m[38;5;231mpost[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186m/search[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;231mexpress[0m[38;5;231m.[0m[38;5;231mjson[0m[38;5;231m()[0m[38;5;231m, [0m[38;5;81masync[0m[38;5;231m [0m[38;5;231m([0m[38;5;208mreq[0m[38;5;231m,[0m[38;5;231m [0m[38;5;208mres[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 727[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231mlogEndpointInfo[0m[38;5;231m([0m[38;5;231mreq[0m[38;5;231m, [0m[38;5;231mres[0m[38;5;231m, [0m[38;5;203m`[0m[38;5;186mG[0m[38;5;186mE[0m[38;5;186mT[0m[38;5;186m [0m[38;5;186m/[0m[38;5;186mm[0m[38;5;186me[0m[38;5;186ms[0m[38;5;186ms[0m[38;5;186ma[0m[38;5;186mg[0m[38;5;186me[0m[38;5;186ms[0m[38;5;186m/[0m[38;5;203m${[0m[38;5;231mreq[0m[38;5;231m.[0m[38;5;231mparams[0m[38;5;231m.[0m[38;5;231mcollectionName[0m[38;5;203m}[0m[38;5;203m`[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 728[0m [32m+[0m [38;5;238mâ”‚[0m 
[38;5;238m 729[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mquery[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mreq[0m[38;5;231m.[0m[38;5;231mbody[0m[38;5;231m.[0m[38;5;231mquery[0m[38;5;231m;[0m
[38;5;238m 730[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mdb[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mclient[0m[38;5;231m.[0m[38;5;231mdb[0m[38;5;231m([0m[38;5;231mMESSAGE_DATABASE[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 731[0m   [38;5;238mâ”‚[0m 
[38;5;238m 732[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;203mtry[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 733[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;242m//[0m[38;5;242m Fetch all collection names[0m
[38;5;238m 734[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mcollections[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;203mawait[0m[38;5;231m [0m[38;5;231mdb[0m[38;5;231m.[0m[38;5;231mlistCollections[0m[38;5;231m()[0m[38;5;231m.[0m[38;5;231mtoArray[0m[38;5;231m()[0m[38;5;231m;[0m
[38;5;238m 735[0m [33m~[0m [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;242m//[0m[38;5;242m remove system.profile, system.index and unified_collections from the listCollection[0m
[38;5;238m 736[0m [33m~[0m [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mcollectionNames[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mcollections[0m
[38;5;238m 737[0m [33m~[0m [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m.[0m[38;5;231mmap[0m[38;5;231m([0m[38;5;231m([0m[38;5;208mc[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231mc[0m[38;5;231m.[0m[38;5;231mname[0m[38;5;231m)[0m
[38;5;238m 738[0m [33m~[0m [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m.[0m[38;5;231mfilter[0m[38;5;231m([0m
[38;5;238m 739[0m [33m~[0m [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;231m([0m[38;5;208mname[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m
[38;5;238m 740[0m [33m~[0m [38;5;238mâ”‚[0m [38;5;231m          [0m[38;5;203m![0m[38;5;231m[[0m[38;5;186m"[0m[38;5;186msystem.profile[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;186m"[0m[38;5;186msystem.indexes[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;186m"[0m[38;5;186munified_collection[0m[38;5;186m"[0m[38;5;231m][0m[38;5;231m.[0m[38;5;231mincludes[0m[38;5;231m([0m
[38;5;238m 741[0m [33m~[0m [38;5;238mâ”‚[0m [38;5;231m            [0m[38;5;231mname[0m
[38;5;238m 742[0m [33m~[0m [38;5;238mâ”‚[0m [38;5;231m          [0m[38;5;231m)[0m
[38;5;238m 743[0m [33m~[0m [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 744[0m   [38;5;238mâ”‚[0m 
[38;5;238m 745[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;242m//[0m[38;5;242m Construct the initial pipeline with $match and $addFields for the first collection[0m
[38;5;238m 746[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231minitialPipeline[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231m[[0m
[38;5;238m 747[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m{[0m
[38;5;238m 748[0m   [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;231m$match[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 749[0m   [38;5;238mâ”‚[0m [38;5;231m          [0m[38;5;231msanitizedContent[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 750[0m   [38;5;238mâ”‚[0m [38;5;231m            [0m[38;5;231m$regex[0m[38;5;231m:[0m[38;5;231m [0m[38;5;203mnew[0m[38;5;231m [0m[38;5;149mRegExp[0m[38;5;231m([0m[38;5;231mdiacritics[0m[38;5;231m.[0m[38;5;231mremove[0m[38;5;231m([0m[38;5;231mquery[0m[38;5;231m)[0m[38;5;231m, [0m[38;5;186m"[0m[38;5;186mi[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m,[0m
[38;5;238m 751[0m   [38;5;238mâ”‚[0m [38;5;231m          [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m 752[0m   [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m 753[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m 754[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m{[0m
[38;5;238m 755[0m   [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;231m$addFields[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 756[0m   [38;5;238mâ”‚[0m [38;5;231m          [0m[38;5;231mcollectionName[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231mcollectionNames[0m[38;5;231m[[0m[38;5;141m0[0m[38;5;231m][0m[38;5;231m,[0m[38;5;231m [0m[38;5;242m//[0m[38;5;242m <-- Add the collection name here[0m
[38;5;238m 757[0m   [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m 758[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m 759[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m][0m[38;5;231m;[0m
[38;5;238m 760[0m   [38;5;238mâ”‚[0m 
[38;5;238m 761[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;242m//[0m[38;5;242m Dynamically add $unionWith stages for the remaining collections[0m
[38;5;238m 762[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231munionWithStages[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mcollectionNames[0m[38;5;231m.[0m[38;5;231mslice[0m[38;5;231m([0m[38;5;141m1[0m[38;5;231m)[0m[38;5;231m.[0m[38;5;231mmap[0m[38;5;231m([0m[38;5;231m([0m[38;5;208mcollectionName[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231m([0m[38;5;231m{[0m
[38;5;238m 763[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m$unionWith[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 764[0m   [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;231mcoll[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231mcollectionName[0m[38;5;231m,[0m
[38;5;238m 765[0m   [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;231mpipeline[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231m[[0m
[38;5;238m 766[0m   [38;5;238mâ”‚[0m [38;5;231m          [0m[38;5;231m{[0m
[38;5;238m 767[0m   [38;5;238mâ”‚[0m [38;5;231m            [0m[38;5;231m$match[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 768[0m   [38;5;238mâ”‚[0m [38;5;231m              [0m[38;5;231msanitizedContent[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 769[0m   [38;5;238mâ”‚[0m [38;5;231m                [0m[38;5;231m$regex[0m[38;5;231m:[0m[38;5;231m [0m[38;5;203mnew[0m[38;5;231m [0m[38;5;149mRegExp[0m[38;5;231m([0m[38;5;231mdiacritics[0m[38;5;231m.[0m[38;5;231mremove[0m[38;5;231m([0m[38;5;231mquery[0m[38;5;231m)[0m[38;5;231m, [0m[38;5;186m"[0m[38;5;186mi[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m,[0m
[38;5;238m 770[0m   [38;5;238mâ”‚[0m [38;5;231m              [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m 771[0m   [38;5;238mâ”‚[0m [38;5;231m            [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m 772[0m   [38;5;238mâ”‚[0m [38;5;231m          [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m 773[0m   [38;5;238mâ”‚[0m [38;5;231m          [0m[38;5;231m{[0m
[38;5;238m 774[0m   [38;5;238mâ”‚[0m [38;5;231m            [0m[38;5;231m$addFields[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 775[0m   [38;5;238mâ”‚[0m [38;5;231m              [0m[38;5;231mcollectionName[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231mcollectionName[0m[38;5;231m,[0m[38;5;231m [0m[38;5;242m//[0m[38;5;242m <-- Add the collection name here[0m
[38;5;238m 776[0m   [38;5;238mâ”‚[0m [38;5;231m            [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m 777[0m   [38;5;238mâ”‚[0m [38;5;231m          [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m 778[0m   [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;231m][0m[38;5;231m,[0m
[38;5;238m 779[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m 780[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m}[0m[38;5;231m)[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 781[0m   [38;5;238mâ”‚[0m 
[38;5;238m 782[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mfinalPipeline[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231minitialPipeline[0m[38;5;231m.[0m[38;5;231mconcat[0m[38;5;231m([0m[38;5;231munionWithStages[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 783[0m   [38;5;238mâ”‚[0m 
[38;5;238m 784[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mpotentialMatches[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;203mawait[0m[38;5;231m [0m[38;5;231mdb[0m
[38;5;238m 785[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m.[0m[38;5;231mcollection[0m[38;5;231m([0m[38;5;231mcollectionNames[0m[38;5;231m[[0m[38;5;141m0[0m[38;5;231m][0m[38;5;231m)[0m
[38;5;238m 786[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m.[0m[38;5;231maggregate[0m[38;5;231m([0m[38;5;231mfinalPipeline[0m[38;5;231m)[0m
[38;5;238m 787[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m.[0m[38;5;231mtoArray[0m[38;5;231m()[0m[38;5;231m;[0m
[38;5;238m 788[0m   [38;5;238mâ”‚[0m 
[38;5;238m 789[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;242m//[0m[38;5;242m Filter out sanitizedContent and convert to lowercase[0m
[38;5;238m 790[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mactualMatches[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mpotentialMatches[0m[38;5;231m.[0m[38;5;231mmap[0m[38;5;231m([0m[38;5;231m([0m[38;5;208mdoc[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 791[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231m{[0m[38;5;231m [0m[38;5;231msanitizedContent[0m[38;5;231m,[0m[38;5;231m [0m[38;5;203m...[0m[38;5;231mrest[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mdoc[0m[38;5;231m;[0m
[38;5;238m 792[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;203mreturn[0m[38;5;231m [0m[38;5;231m{[0m[38;5;231m [0m[38;5;203m...[0m[38;5;231mrest[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m;[0m
[38;5;238m 793[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 794[0m   [38;5;238mâ”‚[0m 
[38;5;238m 795[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231mres[0m[38;5;231m.[0m[38;5;231mjson[0m[38;5;231m([0m[38;5;231mactualMatches[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 796[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m}[0m[38;5;231m [0m[38;5;203mcatch[0m[38;5;231m [0m[38;5;231m([0m[38;5;231merror[0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 797[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;149mconsole[0m[38;5;231m.[0m[38;5;81merror[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mError during aggregation:[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;231merror[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 798[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231mres[0m
[38;5;238m 799[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m.[0m[38;5;231mstatus[0m[38;5;231m([0m[38;5;141m500[0m[38;5;231m)[0m
[38;5;238m 800[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m.[0m[38;5;231mjson[0m[38;5;231m([0m[38;5;231m{[0m[38;5;231m [0m[38;5;231merror[0m[38;5;231m:[0m[38;5;231m [0m[38;5;186m"[0m[38;5;186mAn error occurred while performing the search.[0m[38;5;186m"[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 801[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m}[0m
[38;5;238m 802[0m   [38;5;238mâ”‚[0m [38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 803[0m   [38;5;238mâ”‚[0m 
[38;5;238m 804[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231mapp[0m[38;5;231m.[0m[38;5;231mpost[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186m/search_text[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;231mexpress[0m[38;5;231m.[0m[38;5;231mjson[0m[38;5;231m()[0m[38;5;231m, [0m[38;5;81masync[0m[38;5;231m [0m[38;5;231m([0m[38;5;208mreq[0m[38;5;231m,[0m[38;5;231m [0m[38;5;208mres[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 805[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231mlogEndpointInfo[0m[38;5;231m([0m[38;5;231mreq[0m[38;5;231m, [0m[38;5;231mres[0m[38;5;231m, [0m[38;5;203m`[0m[38;5;186mG[0m[38;5;186mE[0m[38;5;186mT[0m[38;5;186m [0m[38;5;186m/[0m[38;5;186mm[0m[38;5;186me[0m[38;5;186ms[0m[38;5;186ms[0m[38;5;186ma[0m[38;5;186mg[0m[38;5;186me[0m[38;5;186ms[0m[38;5;186m/[0m[38;5;203m${[0m[38;5;231mreq[0m[38;5;231m.[0m[38;5;231mparams[0m[38;5;231m.[0m[38;5;231mcollectionName[0m[38;5;203m}[0m[38;5;203m`[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 806[0m [32m+[0m [38;5;238mâ”‚[0m 
[38;5;238m 807[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mquery[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mreq[0m[38;5;231m.[0m[38;5;231mbody[0m[38;5;231m.[0m[38;5;231mquery[0m[38;5;231m;[0m
[38;5;238m 808[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mdb[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mclient[0m[38;5;231m.[0m[38;5;231mdb[0m[38;5;231m([0m[38;5;231mMESSAGE_DATABASE[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 809[0m [32m+[0m [38;5;238mâ”‚[0m 
[38;5;238m 810[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;203mtry[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 811[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;242m//[0m[38;5;242m Fetch all collection names[0m
[38;5;238m 812[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mcollections[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;203mawait[0m[38;5;231m [0m[38;5;231mdb[0m[38;5;231m.[0m[38;5;231mlistCollections[0m[38;5;231m()[0m[38;5;231m.[0m[38;5;231mtoArray[0m[38;5;231m()[0m[38;5;231m;[0m
[38;5;238m 813[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;242m//[0m[38;5;242m remove system.profile, system.index and unified_collections from the listCollection[0m
[38;5;238m 814[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mcollectionNames[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mcollections[0m
[38;5;238m 815[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m.[0m[38;5;231mmap[0m[38;5;231m([0m[38;5;231m([0m[38;5;208mc[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231mc[0m[38;5;231m.[0m[38;5;231mname[0m[38;5;231m)[0m
[38;5;238m 816[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m.[0m[38;5;231mfilter[0m[38;5;231m([0m
[38;5;238m 817[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;231m([0m[38;5;208mname[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m
[38;5;238m 818[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m          [0m[38;5;203m![0m[38;5;231m[[0m[38;5;186m"[0m[38;5;186msystem.profile[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;186m"[0m[38;5;186msystem.indexes[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;186m"[0m[38;5;186munified_collection[0m[38;5;186m"[0m[38;5;231m][0m[38;5;231m.[0m[38;5;231mincludes[0m[38;5;231m([0m
[38;5;238m 819[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m            [0m[38;5;231mname[0m
[38;5;238m 820[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m          [0m[38;5;231m)[0m
[38;5;238m 821[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 822[0m [32m+[0m [38;5;238mâ”‚[0m 
[38;5;238m 823[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;242m//[0m[38;5;242m Construct the initial pipeline with $match and $addFields for the first collection[0m
[38;5;238m 824[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231minitialPipeline[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231m[[0m
[38;5;238m 825[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m{[0m
[38;5;238m 826[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;231m$match[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 827[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m          [0m[38;5;242m//[0m[38;5;242m do text search instead of regex[0m
[38;5;238m 828[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m          [0m[38;5;231m$text[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 829[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m            [0m[38;5;231m$search[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231mquery[0m[38;5;231m,[0m
[38;5;238m 830[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m          [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m 831[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m 832[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m 833[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m{[0m
[38;5;238m 834[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;231m$addFields[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 835[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m          [0m[38;5;231mcollectionName[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231mcollectionNames[0m[38;5;231m[[0m[38;5;141m0[0m[38;5;231m][0m[38;5;231m,[0m[38;5;231m [0m[38;5;242m//[0m[38;5;242m <-- Add the collection name here[0m
[38;5;238m 836[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m 837[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m 838[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m][0m[38;5;231m;[0m
[38;5;238m 839[0m [32m+[0m [38;5;238mâ”‚[0m 
[38;5;238m 840[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;242m//[0m[38;5;242m Dynamically add $unionWith stages for the remaining collections[0m
[38;5;238m 841[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231munionWithStages[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mcollectionNames[0m[38;5;231m.[0m[38;5;231mslice[0m[38;5;231m([0m[38;5;141m1[0m[38;5;231m)[0m[38;5;231m.[0m[38;5;231mmap[0m[38;5;231m([0m[38;5;231m([0m[38;5;208mcollectionName[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231m([0m[38;5;231m{[0m
[38;5;238m 842[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m$unionWith[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 843[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;231mcoll[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231mcollectionName[0m[38;5;231m,[0m
[38;5;238m 844[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;231mpipeline[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231m[[0m
[38;5;238m 845[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m          [0m[38;5;231m{[0m
[38;5;238m 846[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m            [0m[38;5;231m$match[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 847[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m              [0m[38;5;231msanitizedContent[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 848[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m                [0m[38;5;231m$regex[0m[38;5;231m:[0m[38;5;231m [0m[38;5;203mnew[0m[38;5;231m [0m[38;5;149mRegExp[0m[38;5;231m([0m[38;5;231mdiacritics[0m[38;5;231m.[0m[38;5;231mremove[0m[38;5;231m([0m[38;5;231mquery[0m[38;5;231m)[0m[38;5;231m, [0m[38;5;186m"[0m[38;5;186mi[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m,[0m
[38;5;238m 849[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m              [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m 850[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m            [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m 851[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m          [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m 852[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m          [0m[38;5;231m{[0m
[38;5;238m 853[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m            [0m[38;5;231m$addFields[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 854[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m              [0m[38;5;231mcollectionName[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231mcollectionName[0m[38;5;231m,[0m[38;5;231m [0m[38;5;242m//[0m[38;5;242m <-- Add the collection name here[0m
[38;5;238m 855[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m            [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m 856[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m          [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m 857[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;231m][0m[38;5;231m,[0m
[38;5;238m 858[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m 859[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m}[0m[38;5;231m)[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 860[0m [32m+[0m [38;5;238mâ”‚[0m 
[38;5;238m 861[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mfinalPipeline[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231minitialPipeline[0m[38;5;231m.[0m[38;5;231mconcat[0m[38;5;231m([0m[38;5;231munionWithStages[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 862[0m [32m+[0m [38;5;238mâ”‚[0m 
[38;5;238m 863[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mpotentialMatches[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;203mawait[0m[38;5;231m [0m[38;5;231mdb[0m
[38;5;238m 864[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m.[0m[38;5;231mcollection[0m[38;5;231m([0m[38;5;231mcollectionNames[0m[38;5;231m[[0m[38;5;141m0[0m[38;5;231m][0m[38;5;231m)[0m
[38;5;238m 865[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m.[0m[38;5;231maggregate[0m[38;5;231m([0m[38;5;231mfinalPipeline[0m[38;5;231m)[0m
[38;5;238m 866[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m.[0m[38;5;231mtoArray[0m[38;5;231m()[0m[38;5;231m;[0m
[38;5;238m 867[0m [32m+[0m [38;5;238mâ”‚[0m 
[38;5;238m 868[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;242m//[0m[38;5;242m Filter out sanitizedContent and convert to lowercase[0m
[38;5;238m 869[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mactualMatches[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mpotentialMatches[0m[38;5;231m.[0m[38;5;231mmap[0m[38;5;231m([0m[38;5;231m([0m[38;5;208mdoc[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 870[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231m{[0m[38;5;231m [0m[38;5;231msanitizedContent[0m[38;5;231m,[0m[38;5;231m [0m[38;5;203m...[0m[38;5;231mrest[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mdoc[0m[38;5;231m;[0m
[38;5;238m 871[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;203mreturn[0m[38;5;231m [0m[38;5;231m{[0m[38;5;231m [0m[38;5;203m...[0m[38;5;231mrest[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m;[0m
[38;5;238m 872[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 873[0m [32m+[0m [38;5;238mâ”‚[0m 
[38;5;238m 874[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231mres[0m[38;5;231m.[0m[38;5;231mjson[0m[38;5;231m([0m[38;5;231mactualMatches[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 875[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m}[0m[38;5;231m [0m[38;5;203mcatch[0m[38;5;231m [0m[38;5;231m([0m[38;5;231merror[0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 876[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;149mconsole[0m[38;5;231m.[0m[38;5;81merror[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mError during aggregation:[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;231merror[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 877[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231mres[0m
[38;5;238m 878[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m.[0m[38;5;231mstatus[0m[38;5;231m([0m[38;5;141m500[0m[38;5;231m)[0m
[38;5;238m 879[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m.[0m[38;5;231mjson[0m[38;5;231m([0m[38;5;231m{[0m[38;5;231m [0m[38;5;231merror[0m[38;5;231m:[0m[38;5;231m [0m[38;5;186m"[0m[38;5;186mAn error occurred while performing the search.[0m[38;5;186m"[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 880[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m}[0m
[38;5;238m 881[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 882[0m [32m+[0m [38;5;238mâ”‚[0m 
[38;5;238m 883[0m   [38;5;238mâ”‚[0m [38;5;231mapp[0m[38;5;231m.[0m[38;5;231mget[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186m/photos/:collectionName[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;81masync[0m[38;5;231m [0m[38;5;231m([0m[38;5;208mreq[0m[38;5;231m,[0m[38;5;231m [0m[38;5;208mres[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 884[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mcollectionName[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;81mdecodeURIComponent[0m[38;5;231m([0m[38;5;231mreq[0m[38;5;231m.[0m[38;5;231mparams[0m[38;5;231m.[0m[38;5;231mcollectionName[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 885[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mcacheKey[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;203m`[0m[38;5;186mp[0m[38;5;186mh[0m[38;5;186mo[0m[38;5;186mt[0m[38;5;186mo[0m[38;5;186ms[0m[38;5;186m-[0m[38;5;203m${[0m[38;5;231mcollectionName[0m[38;5;203m}[0m[38;5;203m`[0m[38;5;231m;[0m[38;5;231m [0m[38;5;242m//[0m[38;5;242m Generate a unique cache key[0m
[38;5;238m 886[0m   [38;5;238mâ”‚[0m 
[38;5;238m 887[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;203mtry[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 888[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mcachedData[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;203mawait[0m[38;5;231m [0m[38;5;231mredis[0m[38;5;231m.[0m[38;5;231mget[0m[38;5;231m([0m[38;5;231mcacheKey[0m[38;5;231m)[0m[38;5;231m;[0m[38;5;231m [0m[38;5;242m//[0m[38;5;242m Try to get data from Redis cache[0m
[38;5;238m 889[0m   [38;5;238mâ”‚[0m 
[38;5;238m 890[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;203mif[0m[38;5;231m [0m[38;5;231m([0m[38;5;231mcachedData[0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 891[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;149mconsole[0m[38;5;231m.[0m[38;5;81mlog[0m[38;5;231m([0m[38;5;203m`[0m[38;5;186mC[0m[38;5;186ma[0m[38;5;186mc[0m[38;5;186mh[0m[38;5;186me[0m[38;5;186m [0m[38;5;186mh[0m[38;5;186mi[0m[38;5;186mt[0m[38;5;186m [0m[38;5;186mf[0m[38;5;186mo[0m[38;5;186mr[0m[38;5;186m [0m[38;5;203m${[0m[38;5;231mcacheKey[0m[38;5;203m}[0m[38;5;186m.[0m[38;5;203m`[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 892[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;203mreturn[0m[38;5;231m [0m[38;5;231mres[0m[38;5;231m.[0m[38;5;231mstatus[0m[38;5;231m([0m[38;5;141m200[0m[38;5;231m)[0m[38;5;231m.[0m[38;5;231mjson[0m[38;5;231m([0m[38;5;149mJSON[0m[38;5;231m.[0m[38;5;231mparse[0m[38;5;231m([0m[38;5;231mcachedData[0m[38;5;231m)[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 893[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m}[0m
[38;5;238m 894[0m   [38;5;238mâ”‚[0m 
[38;5;238m 895[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;149mconsole[0m[38;5;231m.[0m[38;5;81mlog[0m[38;5;231m([0m[38;5;203m`[0m[38;5;186mC[0m[38;5;186ma[0m[38;5;186mc[0m[38;5;186mh[0m[38;5;186me[0m[38;5;186m [0m[38;5;186mm[0m[38;5;186mi[0m[38;5;186ms[0m[38;5;186ms[0m[38;5;186m [0m[38;5;186mf[0m[38;5;186mo[0m[38;5;186mr[0m[38;5;186m [0m[38;5;203m${[0m[38;5;231mcacheKey[0m[38;5;203m}[0m[38;5;186m.[0m[38;5;186m [0m[38;5;186mF[0m[38;5;186me[0m[38;5;186mt[0m[38;5;186mc[0m[38;5;186mh[0m[38;5;186mi[0m[38;5;186mn[0m[38;5;186mg[0m[38;5;186m [0m[38;5;186mf[0m[38;5;186mr[0m[38;5;186mo[0m[38;5;186mm[0m[38;5;186m [0m[38;5;186mD[0m[38;5;186mB[0m[38;5;186m.[0m[38;5;203m`[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 896[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mdb[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mclient[0m[38;5;231m.[0m[38;5;231mdb[0m[38;5;231m([0m[38;5;231mMESSAGE_DATABASE[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 897[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mcollection[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mdb[0m[38;5;231m.[0m[38;5;231mcollection[0m[38;5;231m([0m[38;5;231mcollectionName[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 898[0m   [38;5;238mâ”‚[0m 
[38;5;238m 899[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mpipeline[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231m[[0m
[38;5;238m 900[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m{[0m
[38;5;238m 901[0m   [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;231m$match[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 902[0m   [38;5;238mâ”‚[0m [38;5;231m          [0m[38;5;231msender_name[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231m{[0m[38;5;231m [0m[38;5;231m$ne[0m[38;5;231m:[0m[38;5;231m [0m[38;5;186m"[0m[38;5;186mTadeÃ¡Å¡ FoÅ™t[0m[38;5;186m"[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m 903[0m   [38;5;238mâ”‚[0m [38;5;231m          [0m[38;5;231mphotos[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231m{[0m[38;5;231m [0m[38;5;231m$exists[0m[38;5;231m:[0m[38;5;231m [0m[38;5;141mtrue[0m[38;5;231m,[0m[38;5;231m [0m[38;5;231m$not[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231m{[0m[38;5;231m [0m[38;5;231m$size[0m[38;5;231m:[0m[38;5;231m [0m[38;5;141m0[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m 904[0m   [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m 905[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m 906[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m{[0m
[38;5;238m 907[0m   [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;231m$project[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 908[0m   [38;5;238mâ”‚[0m [38;5;231m          [0m[38;5;231m_id[0m[38;5;231m:[0m[38;5;231m [0m[38;5;141m0[0m[38;5;231m,[0m
[38;5;238m 909[0m   [38;5;238mâ”‚[0m [38;5;231m          [0m[38;5;231msender_name[0m[38;5;231m:[0m[38;5;231m [0m[38;5;141m1[0m[38;5;231m,[0m
[38;5;238m 910[0m   [38;5;238mâ”‚[0m [38;5;231m          [0m[38;5;231mtimestamp_ms[0m[38;5;231m:[0m[38;5;231m [0m[38;5;141m1[0m[38;5;231m,[0m
[38;5;238m 911[0m   [38;5;238mâ”‚[0m [38;5;231m          [0m[38;5;231mphotos[0m[38;5;231m:[0m[38;5;231m [0m[38;5;141m1[0m[38;5;231m,[0m
[38;5;238m 912[0m   [38;5;238mâ”‚[0m [38;5;231m          [0m[38;5;231mtimestamp[0m[38;5;231m:[0m[38;5;231m [0m[38;5;141m1[0m[38;5;231m,[0m
[38;5;238m 913[0m   [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m 914[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m 915[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m][0m[38;5;231m;[0m
[38;5;238m 916[0m   [38;5;238mâ”‚[0m 
[38;5;238m 917[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mresults[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;203mawait[0m[38;5;231m [0m[38;5;231mcollection[0m[38;5;231m.[0m[38;5;231maggregate[0m[38;5;231m([0m[38;5;231mpipeline[0m[38;5;231m)[0m[38;5;231m.[0m[38;5;231mtoArray[0m[38;5;231m()[0m[38;5;231m;[0m
[38;5;238m 918[0m   [38;5;238mâ”‚[0m 
[38;5;238m 919[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;242m//[0m[38;5;242m Save the fetched data in Redis with an optional expiry time[0m
[38;5;238m 920[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;203mawait[0m[38;5;231m [0m[38;5;231mredis[0m[38;5;231m.[0m[38;5;231mset[0m[38;5;231m([0m[38;5;231mcacheKey[0m[38;5;231m, [0m[38;5;149mJSON[0m[38;5;231m.[0m[38;5;231mstringify[0m[38;5;231m([0m[38;5;231mresults[0m[38;5;231m)[0m[38;5;231m, [0m[38;5;186m"[0m[38;5;186mEX[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;141m36000[0m[38;5;231m)[0m[38;5;231m;[0m[38;5;231m [0m[38;5;242m//[0m[38;5;242m 10 hours expiry[0m
[38;5;238m 921[0m   [38;5;238mâ”‚[0m 
[38;5;238m 922[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231mres[0m[38;5;231m.[0m[38;5;231mstatus[0m[38;5;231m([0m[38;5;141m200[0m[38;5;231m)[0m[38;5;231m.[0m[38;5;231mjson[0m[38;5;231m([0m[38;5;231mresults[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 923[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m}[0m[38;5;231m [0m[38;5;203mcatch[0m[38;5;231m [0m[38;5;231m([0m[38;5;231merror[0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 924[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;149mconsole[0m[38;5;231m.[0m[38;5;81merror[0m[38;5;231m([0m[38;5;231merror[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 925[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231mres[0m[38;5;231m.[0m[38;5;231mstatus[0m[38;5;231m([0m[38;5;141m500[0m[38;5;231m)[0m[38;5;231m.[0m[38;5;231msend[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mInternal Server Error[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 926[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m}[0m
[38;5;238m 927[0m   [38;5;238mâ”‚[0m [38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 928[0m   [38;5;238mâ”‚[0m 
[38;5;238m 929[0m   [38;5;238mâ”‚[0m [38;5;242m//[0m[38;5;242m Custom error handling middleware[0m
[38;5;238m 930[0m   [38;5;238mâ”‚[0m [38;5;231mapp[0m[38;5;231m.[0m[38;5;231muse[0m[38;5;231m([0m[38;5;231m([0m[38;5;208merr[0m[38;5;231m,[0m[38;5;231m [0m[38;5;208mreq[0m[38;5;231m,[0m[38;5;231m [0m[38;5;208mres[0m[38;5;231m,[0m[38;5;231m [0m[38;5;208mnext[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 931[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;203mif[0m[38;5;231m [0m[38;5;231m([0m[38;5;231merr[0m[38;5;231m [0m[38;5;203minstanceof[0m[38;5;231m [0m[38;5;231mmulter[0m[38;5;231m.[0m[38;5;231mMulterError[0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 932[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;242m//[0m[38;5;242m A Multer error occurred when uploading.[0m
[38;5;238m 933[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;149mconsole[0m[38;5;231m.[0m[38;5;81merror[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mMulterError encountered:[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;231merr[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 934[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;203mreturn[0m[38;5;231m [0m[38;5;231mres[0m
[38;5;238m 935[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m.[0m[38;5;231mstatus[0m[38;5;231m([0m[38;5;141m400[0m[38;5;231m)[0m
[38;5;238m 936[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m.[0m[38;5;231mjson[0m[38;5;231m([0m[38;5;231m{[0m[38;5;231m [0m[38;5;231merror[0m[38;5;231m:[0m[38;5;231m [0m[38;5;186m"[0m[38;5;186mFile upload error[0m[38;5;186m"[0m[38;5;231m,[0m[38;5;231m [0m[38;5;231mdetails[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231merr[0m[38;5;231m.[0m[38;5;231mmessage[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 937[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m}[0m[38;5;231m [0m[38;5;203melse[0m[38;5;231m [0m[38;5;203mif[0m[38;5;231m [0m[38;5;231m([0m[38;5;231merr[0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 938[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;242m//[0m[38;5;242m An unknown error occurred.[0m
[38;5;238m 939[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;149mconsole[0m[38;5;231m.[0m[38;5;81merror[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mAn unknown error occurred:[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;231merr[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 940[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;203mreturn[0m[38;5;231m [0m[38;5;231mres[0m
[38;5;238m 941[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m.[0m[38;5;231mstatus[0m[38;5;231m([0m[38;5;141m500[0m[38;5;231m)[0m
[38;5;238m 942[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m.[0m[38;5;231mjson[0m[38;5;231m([0m[38;5;231m{[0m[38;5;231m [0m[38;5;231merror[0m[38;5;231m:[0m[38;5;231m [0m[38;5;186m"[0m[38;5;186mAn error occurred[0m[38;5;186m"[0m[38;5;231m,[0m[38;5;231m [0m[38;5;231mdetails[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231merr[0m[38;5;231m.[0m[38;5;231mmessage[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 943[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m}[0m
[38;5;238m 944[0m   [38;5;238mâ”‚[0m 
[38;5;238m 945[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;242m//[0m[38;5;242m Pass to next middleware if no errors[0m
[38;5;238m 946[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231mnext[0m[38;5;231m()[0m[38;5;231m;[0m
[38;5;238m 947[0m   [38;5;238mâ”‚[0m [38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 948[0m   [38;5;238mâ”‚[0m 
[38;5;238m 949[0m   [38;5;238mâ”‚[0m [38;5;242m//[0m[38;5;242m ----------------- DB SWITCHING----------------- //[0m
[38;5;238m 950[0m   [38;5;238mâ”‚[0m [38;5;242m//[0m[38;5;242m Add an endpoint to switch the database based on the URL parameter[0m
[38;5;238m 951[0m [33m~[0m [38;5;238mâ”‚[0m [38;5;231mapp[0m[38;5;231m.[0m[38;5;231mget[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186m/switch_db/:dbName[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;81masync[0m[38;5;231m [0m[38;5;231m([0m[38;5;208mreq[0m[38;5;231m,[0m[38;5;231m [0m[38;5;208mres[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 952[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231m{[0m[38;5;231m [0m[38;5;231mdbName[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mreq[0m[38;5;231m.[0m[38;5;231mparams[0m[38;5;231m;[0m
[38;5;238m 953[0m [33m~[0m [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;203mawait[0m[38;5;231m [0m[38;5;231mredis[0m[38;5;231m.[0m[38;5;231mpublish[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mDB_SWITCH_CHANNEL[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;231mdbName[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 954[0m [33m~[0m [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231mres[0m[38;5;231m.[0m[38;5;231msend[0m[38;5;231m([0m[38;5;203m`[0m[38;5;186mD[0m[38;5;186ma[0m[38;5;186mt[0m[38;5;186ma[0m[38;5;186mb[0m[38;5;186ma[0m[38;5;186ms[0m[38;5;186me[0m[38;5;186m [0m[38;5;186ms[0m[38;5;186mw[0m[38;5;186mi[0m[38;5;186mt[0m[38;5;186mc[0m[38;5;186mh[0m[38;5;186m [0m[38;5;186mi[0m[38;5;186mn[0m[38;5;186mi[0m[38;5;186mt[0m[38;5;186mi[0m[38;5;186ma[0m[38;5;186mt[0m[38;5;186me[0m[38;5;186md[0m[38;5;186m:[0m[38;5;186m [0m[38;5;203m${[0m[38;5;231mdbName[0m[38;5;203m}[0m[38;5;203m`[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 955[0m   [38;5;238mâ”‚[0m [38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 956[0m [32m+[0m [38;5;238mâ”‚[0m 
[38;5;238m 957[0m   [38;5;238mâ”‚[0m [38;5;242m//[0m[38;5;242m Add another endpoint to toggle the MESSAGE_DATABASE between two values[0m
[38;5;238m 958[0m   [38;5;238mâ”‚[0m [38;5;231mapp[0m[38;5;231m.[0m[38;5;231mget[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186m/switch_db/[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;81masync[0m[38;5;231m [0m[38;5;231m([0m[38;5;208mreq[0m[38;5;231m,[0m[38;5;231m [0m[38;5;208mres[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 959[0m [33m~[0m [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;242m//[0m[38;5;242m Determine the new database value[0m
[38;5;238m 960[0m [33m~[0m [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mnewDb[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mMESSAGE_DATABASE[0m[38;5;231m [0m[38;5;203m===[0m[38;5;231m [0m[38;5;186m"[0m[38;5;186mmessages[0m[38;5;186m"[0m[38;5;231m [0m[38;5;203m?[0m[38;5;231m [0m[38;5;186m"[0m[38;5;186mmessage_backup[0m[38;5;186m"[0m[38;5;231m [0m[38;5;231m:[0m[38;5;231m [0m[38;5;186m"[0m[38;5;186mmessages[0m[38;5;186m"[0m[38;5;231m;[0m
[38;5;238m 961[0m   [38;5;238mâ”‚[0m 
[38;5;238m 962[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;203mtry[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 963[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;242m//[0m[38;5;242m Publish the new database name to a Redis channel[0m
[38;5;238m 964[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;203mawait[0m[38;5;231m [0m[38;5;231mredis[0m[38;5;231m.[0m[38;5;231mpublish[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mDB_SWITCH_CHANNEL[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;231mnewDb[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 965[0m [32m+[0m [38;5;238mâ”‚[0m 
[38;5;238m 966[0m [32m+[0m [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;242m//[0m[38;5;242m Optionally, flush Redis database if needed[0m
[38;5;238m 967[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;203mawait[0m[38;5;231m [0m[38;5;231mredis[0m[38;5;231m.[0m[38;5;231mflushdb[0m[38;5;231m()[0m[38;5;231m;[0m
[38;5;238m 968[0m [33m~[0m [38;5;238mâ”‚[0m 
[38;5;238m 969[0m [33m~[0m [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231mres[0m[38;5;231m.[0m[38;5;231msend[0m[38;5;231m([0m[38;5;203m`[0m[38;5;186mD[0m[38;5;186ma[0m[38;5;186mt[0m[38;5;186ma[0m[38;5;186mb[0m[38;5;186ma[0m[38;5;186ms[0m[38;5;186me[0m[38;5;186m [0m[38;5;186ms[0m[38;5;186mw[0m[38;5;186mi[0m[38;5;186mt[0m[38;5;186mc[0m[38;5;186mh[0m[38;5;186m [0m[38;5;186mi[0m[38;5;186mn[0m[38;5;186mi[0m[38;5;186mt[0m[38;5;186mi[0m[38;5;186ma[0m[38;5;186mt[0m[38;5;186me[0m[38;5;186md[0m[38;5;186m:[0m[38;5;186m [0m[38;5;203m${[0m[38;5;231mnewDb[0m[38;5;203m}[0m[38;5;203m`[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 970[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m}[0m[38;5;231m [0m[38;5;203mcatch[0m[38;5;231m [0m[38;5;231m([0m[38;5;231merror[0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 971[0m [33m~[0m [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;149mconsole[0m[38;5;231m.[0m[38;5;81merror[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mError switching database:[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;231merror[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 972[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231mres[0m[38;5;231m.[0m[38;5;231mstatus[0m[38;5;231m([0m[38;5;141m500[0m[38;5;231m)[0m[38;5;231m.[0m[38;5;231msend[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mInternal Server Error[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 973[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m}[0m
[38;5;238m 974[0m   [38;5;238mâ”‚[0m [38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 975[0m   [38;5;238mâ”‚[0m 
[38;5;238m 976[0m   [38;5;238mâ”‚[0m [38;5;242m//[0m[38;5;242m Example usage of the MESSAGE_DATABASE variable[0m
[38;5;238m 977[0m   [38;5;238mâ”‚[0m [38;5;231mapp[0m[38;5;231m.[0m[38;5;231mget[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186m/current_db[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;231m([0m[38;5;208mreq[0m[38;5;231m,[0m[38;5;231m [0m[38;5;208mres[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 978[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231mres[0m[38;5;231m.[0m[38;5;231msend[0m[38;5;231m([0m[38;5;203m`[0m[38;5;203m${[0m[38;5;231mMESSAGE_DATABASE[0m[38;5;203m}[0m[38;5;203m`[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 979[0m   [38;5;238mâ”‚[0m [38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 980[0m   [38;5;238mâ”‚[0m 
[38;5;238m 981[0m   [38;5;238mâ”‚[0m [38;5;231mapp[0m[38;5;231m.[0m[38;5;231mget[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186m/flush_redis[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;81masync[0m[38;5;231m [0m[38;5;231m([0m[38;5;208mreq[0m[38;5;231m,[0m[38;5;231m [0m[38;5;208mres[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 982[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;203mtry[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 983[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;203mawait[0m[38;5;231m [0m[38;5;231mredis[0m[38;5;231m.[0m[38;5;231mflushdb[0m[38;5;231m()[0m[38;5;231m;[0m
[38;5;238m 984[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231mres[0m[38;5;231m.[0m[38;5;231msend[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mRedis cache flushed successfully.[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 985[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m}[0m[38;5;231m [0m[38;5;203mcatch[0m[38;5;231m [0m[38;5;231m([0m[38;5;231merror[0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 986[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;149mconsole[0m[38;5;231m.[0m[38;5;81merror[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mError flushing Redis cache:[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;231merror[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 987[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231mres[0m[38;5;231m.[0m[38;5;231mstatus[0m[38;5;231m([0m[38;5;141m500[0m[38;5;231m)[0m[38;5;231m.[0m[38;5;231msend[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mInternal Server Error[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 988[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m}[0m
[38;5;238m 989[0m   [38;5;238mâ”‚[0m [38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m 990[0m   [38;5;238mâ”‚[0m 
[38;5;238m 991[0m   [38;5;238mâ”‚[0m [38;5;242m//[0m[38;5;242m ----------------- STRESS TESTING ----------------- //[0m
[38;5;238m 992[0m   [38;5;238mâ”‚[0m [38;5;231mapp[0m[38;5;231m.[0m[38;5;231mget[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186m/load-cpu[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;231m([0m[38;5;208mreq[0m[38;5;231m,[0m[38;5;231m [0m[38;5;208mres[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 993[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;81mlet[0m[38;5;231m [0m[38;5;231mtotal[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;141m0[0m[38;5;231m;[0m
[38;5;238m 994[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;203mfor[0m[38;5;231m [0m[38;5;231m([0m[38;5;81mlet[0m[38;5;231m [0m[38;5;231mi[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;141m0[0m[38;5;231m;[0m[38;5;231m [0m[38;5;231mi[0m[38;5;231m [0m[38;5;203m<[0m[38;5;231m [0m[38;5;141m7000000[0m[38;5;231m;[0m[38;5;231m [0m[38;5;231mi[0m[38;5;203m++[0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m 995[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231mtotal[0m[38;5;231m [0m[38;5;203m+=[0m[38;5;231m [0m[38;5;149mMath[0m[38;5;231m.[0m[38;5;231msqrt[0m[38;5;231m([0m[38;5;231mi[0m[38;5;231m)[0m[38;5;231m [0m[38;5;203m*[0m[38;5;231m [0m[38;5;149mMath[0m[38;5;231m.[0m[38;5;231mrandom[0m[38;5;231m()[0m[38;5;231m;[0m
[38;5;238m 996[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231mtotal[0m[38;5;231m [0m[38;5;203m-=[0m[38;5;231m [0m[38;5;149mMath[0m[38;5;231m.[0m[38;5;231mpow[0m[38;5;231m([0m[38;5;231mi[0m[38;5;231m, [0m[38;5;141m2[0m[38;5;231m)[0m[38;5;231m [0m[38;5;203m*[0m[38;5;231m [0m[38;5;149mMath[0m[38;5;231m.[0m[38;5;231mrandom[0m[38;5;231m()[0m[38;5;231m;[0m
[38;5;238m 997[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231mtotal[0m[38;5;231m [0m[38;5;203m*=[0m[38;5;231m [0m[38;5;149mMath[0m[38;5;231m.[0m[38;5;231msin[0m[38;5;231m([0m[38;5;231mi[0m[38;5;231m)[0m[38;5;231m [0m[38;5;203m*[0m[38;5;231m [0m[38;5;149mMath[0m[38;5;231m.[0m[38;5;231mrandom[0m[38;5;231m()[0m[38;5;231m;[0m
[38;5;238m 998[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m}[0m
[38;5;238m 999[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231mres[0m[38;5;231m.[0m[38;5;231msend[0m[38;5;231m([0m[38;5;203m`[0m[38;5;186mT[0m[38;5;186mh[0m[38;5;186me[0m[38;5;186m [0m[38;5;186mr[0m[38;5;186me[0m[38;5;186ms[0m[38;5;186mu[0m[38;5;186ml[0m[38;5;186mt[0m[38;5;186m [0m[38;5;186mo[0m[38;5;186mf[0m[38;5;186m [0m[38;5;186mt[0m[38;5;186mh[0m[38;5;186me[0m[38;5;186m [0m[38;5;186mC[0m[38;5;186mP[0m[38;5;186mU[0m[38;5;186m [0m[38;5;186mi[0m[38;5;186mn[0m[38;5;186mt[0m[38;5;186me[0m[38;5;186mn[0m[38;5;186ms[0m[38;5;186mi[0m[38;5;186mv[0m[38;5;186me[0m[38;5;186m [0m[38;5;186mt[0m[38;5;186ma[0m[38;5;186ms[0m[38;5;186mk[0m[38;5;186m [0m[38;5;186mi[0m[38;5;186ms[0m[38;5;186m [0m[38;5;203m${[0m[38;5;231mtotal[0m[38;5;203m}[0m[38;5;141m\n[0m[38;5;203m`[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m1000[0m   [38;5;238mâ”‚[0m [38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m1001[0m   [38;5;238mâ”‚[0m 
[38;5;238m1002[0m   [38;5;238mâ”‚[0m [38;5;231mapp[0m[38;5;231m.[0m[38;5;231mget[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186m/stress-test[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;81masync[0m[38;5;231m [0m[38;5;231m([0m[38;5;208mreq[0m[38;5;231m,[0m[38;5;231m [0m[38;5;208mres[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m1003[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;203mtry[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m1004[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mstartTime[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;149mDate[0m[38;5;231m.[0m[38;5;231mnow[0m[38;5;231m()[0m[38;5;231m;[0m
[38;5;238m1005[0m   [38;5;238mâ”‚[0m 
[38;5;238m1006[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;242m//[0m[38;5;242m Generate a random czech word and sanitize it[0m
[38;5;238m1007[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mrandomWord[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mgenerate[0m[38;5;231m()[0m[38;5;231m;[0m
[38;5;238m1008[0m   [38;5;238mâ”‚[0m 
[38;5;238m1009[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231msanitizedRandomWord[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231msanitizeName[0m[38;5;231m([0m[38;5;231mrandomWord[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m1010[0m   [38;5;238mâ”‚[0m 
[38;5;238m1011[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;242m//[0m[38;5;242m Trigger the cross-collection search[0m
[38;5;238m1012[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mdb[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mclient[0m[38;5;231m.[0m[38;5;231mdb[0m[38;5;231m([0m[38;5;231mMESSAGE_DATABASE[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m1013[0m   [38;5;238mâ”‚[0m 
[38;5;238m1014[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;242m//[0m[38;5;242m Fetch all collection names[0m
[38;5;238m1015[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mcollections[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;203mawait[0m[38;5;231m [0m[38;5;231mdb[0m[38;5;231m.[0m[38;5;231mlistCollections[0m[38;5;231m()[0m[38;5;231m.[0m[38;5;231mtoArray[0m[38;5;231m()[0m[38;5;231m;[0m
[38;5;238m1016[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mcollectionNames[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mcollections[0m[38;5;231m.[0m[38;5;231mmap[0m[38;5;231m([0m[38;5;231m([0m[38;5;208mc[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231mc[0m[38;5;231m.[0m[38;5;231mname[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m1017[0m   [38;5;238mâ”‚[0m 
[38;5;238m1018[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;242m//[0m[38;5;242m Construct the initial pipeline with $match and $addFields for the first collection[0m
[38;5;238m1019[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231minitialPipeline[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231m[[0m
[38;5;238m1020[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m{[0m
[38;5;238m1021[0m   [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;231m$match[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m1022[0m [33m~[0m [38;5;238mâ”‚[0m [38;5;231m          [0m[38;5;231m$text[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m1023[0m [33m~[0m [38;5;238mâ”‚[0m [38;5;231m            [0m[38;5;231m$search[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231msanitizedRandomWord[0m[38;5;231m,[0m
[38;5;238m1024[0m   [38;5;238mâ”‚[0m [38;5;231m          [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m1025[0m   [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m1026[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m1027[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m{[0m
[38;5;238m1028[0m   [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;231m$addFields[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m1029[0m   [38;5;238mâ”‚[0m [38;5;231m          [0m[38;5;231mcollectionName[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231mcollectionNames[0m[38;5;231m[[0m[38;5;141m0[0m[38;5;231m][0m[38;5;231m,[0m
[38;5;238m1030[0m   [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m1031[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m1032[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m][0m[38;5;231m;[0m
[38;5;238m1033[0m   [38;5;238mâ”‚[0m 
[38;5;238m1034[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;242m//[0m[38;5;242m Dynamically add $unionWith stages for the remaining collections[0m
[38;5;238m1035[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231munionWithStages[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mcollectionNames[0m[38;5;231m.[0m[38;5;231mslice[0m[38;5;231m([0m[38;5;141m1[0m[38;5;231m)[0m[38;5;231m.[0m[38;5;231mmap[0m[38;5;231m([0m[38;5;231m([0m[38;5;208mcollectionName[0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231m([0m[38;5;231m{[0m
[38;5;238m1036[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m$unionWith[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m1037[0m   [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;231mcoll[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231mcollectionName[0m[38;5;231m,[0m
[38;5;238m1038[0m   [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;231mpipeline[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231m[[0m
[38;5;238m1039[0m   [38;5;238mâ”‚[0m [38;5;231m          [0m[38;5;231m{[0m
[38;5;238m1040[0m   [38;5;238mâ”‚[0m [38;5;231m            [0m[38;5;231m$match[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m1041[0m   [38;5;238mâ”‚[0m [38;5;231m              [0m[38;5;231mcontent[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m1042[0m   [38;5;238mâ”‚[0m [38;5;231m                [0m[38;5;231m$regex[0m[38;5;231m:[0m[38;5;231m [0m[38;5;203mnew[0m[38;5;231m [0m[38;5;149mRegExp[0m[38;5;231m([0m[38;5;231msanitizedRandomWord[0m[38;5;231m, [0m[38;5;186m"[0m[38;5;186mi[0m[38;5;186m"[0m[38;5;231m)[0m[38;5;231m,[0m
[38;5;238m1043[0m   [38;5;238mâ”‚[0m [38;5;231m              [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m1044[0m   [38;5;238mâ”‚[0m [38;5;231m            [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m1045[0m   [38;5;238mâ”‚[0m [38;5;231m          [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m1046[0m   [38;5;238mâ”‚[0m [38;5;231m          [0m[38;5;231m{[0m
[38;5;238m1047[0m   [38;5;238mâ”‚[0m [38;5;231m            [0m[38;5;231m$addFields[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m1048[0m   [38;5;238mâ”‚[0m [38;5;231m              [0m[38;5;231mcollectionName[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231mcollectionName[0m[38;5;231m,[0m
[38;5;238m1049[0m   [38;5;238mâ”‚[0m [38;5;231m            [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m1050[0m   [38;5;238mâ”‚[0m [38;5;231m          [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m1051[0m   [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;231m][0m[38;5;231m,[0m
[38;5;238m1052[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m}[0m[38;5;231m,[0m
[38;5;238m1053[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m}[0m[38;5;231m)[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m1054[0m   [38;5;238mâ”‚[0m 
[38;5;238m1055[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mfinalPipeline[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231minitialPipeline[0m[38;5;231m.[0m[38;5;231mconcat[0m[38;5;231m([0m[38;5;231munionWithStages[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m1056[0m   [38;5;238mâ”‚[0m 
[38;5;238m1057[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mpotentialMatches[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;203mawait[0m[38;5;231m [0m[38;5;231mdb[0m
[38;5;238m1058[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m.[0m[38;5;231mcollection[0m[38;5;231m([0m[38;5;231mcollectionNames[0m[38;5;231m[[0m[38;5;141m0[0m[38;5;231m][0m[38;5;231m)[0m
[38;5;238m1059[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m.[0m[38;5;231maggregate[0m[38;5;231m([0m[38;5;231mfinalPipeline[0m[38;5;231m)[0m
[38;5;238m1060[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m.[0m[38;5;231mtoArray[0m[38;5;231m()[0m[38;5;231m;[0m
[38;5;238m1061[0m   [38;5;238mâ”‚[0m 
[38;5;238m1062[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mendTime[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;149mDate[0m[38;5;231m.[0m[38;5;231mnow[0m[38;5;231m()[0m[38;5;231m;[0m
[38;5;238m1063[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;81mconst[0m[38;5;231m [0m[38;5;231mduration[0m[38;5;231m [0m[38;5;203m=[0m[38;5;231m [0m[38;5;231mendTime[0m[38;5;231m [0m[38;5;203m-[0m[38;5;231m [0m[38;5;231mstartTime[0m[38;5;231m;[0m
[38;5;238m1064[0m   [38;5;238mâ”‚[0m 
[38;5;238m1065[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;242m//[0m[38;5;242m Respond with the time taken to complete the stress test[0m
[38;5;238m1066[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231mres[0m[38;5;231m.[0m[38;5;231mjson[0m[38;5;231m([0m[38;5;231m{[0m
[38;5;238m1067[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231mmessage[0m[38;5;231m:[0m[38;5;231m [0m[38;5;186m"[0m[38;5;186mStress test completed successfully[0m[38;5;186m"[0m[38;5;231m,[0m
[38;5;238m1068[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231msearchString[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231mrandomWord[0m[38;5;231m,[0m
[38;5;238m1069[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231mduration[0m[38;5;231m:[0m[38;5;231m [0m[38;5;203m`[0m[38;5;203m${[0m[38;5;231mduration[0m[38;5;203m}[0m[38;5;186m [0m[38;5;186mm[0m[38;5;186ms[0m[38;5;203m`[0m[38;5;231m,[0m
[38;5;238m1070[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231msearchMatches[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231mpotentialMatches[0m[38;5;231m.[0m[38;5;231mlength[0m[38;5;231m,[0m
[38;5;238m1071[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231mrandomMatch[0m[38;5;231m:[0m
[38;5;238m1072[0m   [38;5;238mâ”‚[0m [38;5;231m        [0m[38;5;231mpotentialMatches[0m[38;5;231m[[0m[38;5;149mMath[0m[38;5;231m.[0m[38;5;231mfloor[0m[38;5;231m([0m[38;5;149mMath[0m[38;5;231m.[0m[38;5;231mrandom[0m[38;5;231m()[0m[38;5;231m [0m[38;5;203m*[0m[38;5;231m [0m[38;5;231mpotentialMatches[0m[38;5;231m.[0m[38;5;231mlength[0m[38;5;231m)[0m[38;5;231m][0m[38;5;231m,[0m
[38;5;238m1073[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231mdata[0m[38;5;231m:[0m[38;5;231m [0m[38;5;231mpotentialMatches[0m[38;5;231m,[0m
[38;5;238m1074[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m1075[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m}[0m[38;5;231m [0m[38;5;203mcatch[0m[38;5;231m [0m[38;5;231m([0m[38;5;231merror[0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m1076[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;149mconsole[0m[38;5;231m.[0m[38;5;81merror[0m[38;5;231m([0m[38;5;186m"[0m[38;5;186mError during stress-test:[0m[38;5;186m"[0m[38;5;231m, [0m[38;5;231merror[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m1077[0m   [38;5;238mâ”‚[0m [38;5;231m    [0m[38;5;231mres[0m
[38;5;238m1078[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m.[0m[38;5;231mstatus[0m[38;5;231m([0m[38;5;141m500[0m[38;5;231m)[0m
[38;5;238m1079[0m   [38;5;238mâ”‚[0m [38;5;231m      [0m[38;5;231m.[0m[38;5;231mjson[0m[38;5;231m([0m[38;5;231m{[0m[38;5;231m [0m[38;5;231merror[0m[38;5;231m:[0m[38;5;231m [0m[38;5;186m"[0m[38;5;186mAn error occurred during the stress test.[0m[38;5;186m"[0m[38;5;231m [0m[38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m1080[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;231m}[0m
[38;5;238m1081[0m   [38;5;238mâ”‚[0m [38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m1082[0m   [38;5;238mâ”‚[0m 
[38;5;238m1083[0m   [38;5;238mâ”‚[0m [38;5;231mapp[0m[38;5;231m.[0m[38;5;231mlisten[0m[38;5;231m([0m[38;5;231mport[0m[38;5;231m, [0m[38;5;231m([0m[38;5;231m)[0m[38;5;231m [0m[38;5;81m=>[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;238m1084[0m   [38;5;238mâ”‚[0m [38;5;231m  [0m[38;5;149mconsole[0m[38;5;231m.[0m[38;5;81mlog[0m[38;5;231m([0m[38;5;203m`[0m[38;5;186mS[0m[38;5;186me[0m[38;5;186mr[0m[38;5;186mv[0m[38;5;186me[0m[38;5;186mr[0m[38;5;186m [0m[38;5;186ml[0m[38;5;186mi[0m[38;5;186ms[0m[38;5;186mt[0m[38;5;186me[0m[38;5;186mn[0m[38;5;186mi[0m[38;5;186mn[0m[38;5;186mg[0m[38;5;186m [0m[38;5;186mo[0m[38;5;186mn[0m[38;5;186m [0m[38;5;186mp[0m[38;5;186mo[0m[38;5;186mr[0m[38;5;186mt[0m[38;5;186m [0m[38;5;186mn[0m[38;5;186mu[0m[38;5;186mm[0m[38;5;186mb[0m[38;5;186me[0m[38;5;186mr[0m[38;5;186m:[0m[38;5;186m [0m[38;5;203m${[0m[38;5;231mport[0m[38;5;203m}[0m[38;5;203m`[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238m1085[0m   [38;5;238mâ”‚[0m [38;5;231m}[0m[38;5;231m)[0m[38;5;231m;[0m
[38;5;238mâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[0m
